!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.VeloxWebView=factory()}(this,function(){"use strict";function uuidv4(){return uuidBase||(uuidBase=void 0!==window.crypto&&crypto.getRandomValues?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(c){return(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)}):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)})),uuidBase+"-"+uuidInc++}function EventEmiter(){this.listeners={}}function evalExpr(currentData,expr){if(currentData){var argNames=[],argValues=[];Object.keys(currentData).forEach(function(k){argNames.push(k),argValues.push(currentData[k])});for(var i=0;i<20;){i++;try{return new Function(argNames.join(","),"return "+expr).apply(null,argValues)}catch(e){if("ReferenceError"===e.name){var varName=e.message.split(" ")[0].replace(/'/g,"");argNames.push(varName),argValues.push(void 0);continue}return console.error("Error while evaluing expr "+expr,e),!1}}return console.error("More than 20 retry of "+expr+" there is something wrong in it !"),!1}return!1}function pathExtract(obj,path,getParent){if(!path)return obj;var pathArray=path;pathArray=Array.isArray(path)?path.slice():path.split("."),getParent&&pathArray.pop();for(var objectPath=[],dataObject=obj;pathArray.length>0;){var p=pathArray.shift().trim(),index=null;-1!=p.indexOf("[")&&(index=p.substring(p.indexOf("[")+1,p.indexOf("]")).trim(),p=p.substring(0,p.indexOf("[")).trim()),dataObject&&(p&&"$parent"===p?dataObject=objectPath.pop():p&&"$this"!==p&&(objectPath.push(dataObject),dataObject=dataObject[p]),dataObject&&null!==index&&(dataObject=dataObject[index]))}return dataObject}function convertRelativeToAbsolutePath(base,relative){var finalPath=[];return base.split("/").concat(relative.split("/")).forEach(function(p){".."===p?finalPath.pop():"."!==p&&finalPath.push(p)}),finalPath.join("/")}function pathSetValue(obj,path,value){var pathArray=path.slice();Array.isArray(path)||(pathArray=path.split("."));for(var dataObject=obj;pathArray.length>0;){var p=pathArray.shift().trim(),index=null;-1!==p.indexOf("[")&&(index=parseInt(p.substring(p.indexOf("[")+1,p.indexOf("]")).trim(),10),p=p.substring(0,p.indexOf("[")).trim()),dataObject&&(0===pathArray.length?null!==index?(p&&"this"!==p&&(dataObject[p]||(dataObject[p]=[]),dataObject=dataObject[p]),dataObject[index]=value):dataObject[p]=value:(p&&"this"!==p&&(dataObject[p]||(dataObject[p]=null!==index?[]:{}),dataObject=dataObject[p]),dataObject&&null!==index&&(dataObject[index]||(dataObject[index]={}),dataObject=dataObject[index])))}}function asyncSeries(calls,callback){if(0===calls.length)return callback();(0,calls[0])(function(err){if(err)return callback(err);calls.length>50&&calls.length%50==0?setImmediate(function(){asyncSeries(calls.slice(1),callback)}):asyncSeries(calls.slice(1),callback)})}function insertChild(parentElement,element,insertBefore,insertAfter){var nextElement=null,previousElement=null;if(insertBefore||insertAfter){var children=parentElement.children;if(insertBefore){var afterChain=insertBefore;for(afterChain=Array.isArray(afterChain)?afterChain.slice():[afterChain];null===nextElement&&afterChain.length>0;)for(var afterId=afterChain.shift(),i=0;i<children.length;i++)if(children[i].getAttribute("data-vieworder-id")===afterId){nextElement=children[i];break}}if(insertAfter)if("string"==typeof insertAfter||"string"==typeof insertAfter[0]){for(var beforeId=1===insertAfter.length?insertAfter[0]:insertAfter,i=children.length-1;i>=0;i--)if(children[i].getAttribute("data-vieworder-id")===beforeId){previousElement=children[i];break}}else{var beforeChain=insertAfter;for(beforeChain=Array.isArray(beforeChain)?beforeChain.slice():[beforeChain];null===previousElement&&beforeChain.length>0;)for(var beforeId=beforeChain.shift(),i=0;i<children.length;i++)if(children[i].getAttribute("data-vieworder-id")===beforeId){previousElement=children[i];break}}}nextElement?parentElement.insertBefore(element,nextElement):previousElement?parentElement.insertBefore(element,previousElement.nextSibling):parentElement.appendChild(element)}function VeloxWebView(directory,name,options){EventEmiter.call(this),directory&&"object"==typeof directory&&(options=directory,directory=null,name=null),this.uid=uuidv4(),this.options=options||{},this.directory=directory,this.name=name,this.views={},this.initDone=!1,this.bindObject=null,this.bindPath=null,this.innerViewIds=[],this.waitCount=0,Object.defineProperty(this,"EL",{get:function(){if(!this.ids)throw"Try to access element before initialization, consider to use ensureInit()";var els=this.elements,elFound=!1;return els||(els={},Object.keys(this.ids).forEach(function(id){if(this.container.id===this.ids[id])els[id]=this.container;else try{els[id]=this.container.querySelector("#"+this.ids[id])}catch(e){els[id]=null}if(els[id]){var view=this,elAddEventListener=els[id].addEventListener;els[id].addEventListener=function(event,listener){elAddEventListener.call(els[id],event,function(ev){ev.viewOfElement=view,listener.bind(els[id])(ev)})},els[id].on=els[id].addEventListener,elFound=!0}}.bind(this)),this.innerViewIds.forEach(function(innerViewId){els[innerViewId.id]=innerViewId}.bind(this))),elFound&&(this.elements=els),els}.bind(this)}),VeloxWebView.extensions.forEach(function(extension){extension.extendsObj&&Object.keys(extension.extendsObj).forEach(function(key){this[key]=extension.extendsObj[key].bind(this)}.bind(this))}.bind(this))}var HTMLELEMENT_PROTO_KEYS=Object.keys(Element.prototype).concat(Object.keys(HTMLElement.prototype)),loadedCss={},parsedHTMLCache={},uuidBase=null,uuidInc=0;return EventEmiter.prototype.on=function(type,listener){return this.listeners[type]||(this.listeners[type]=[]),this.listeners[type].push(listener),this},EventEmiter.prototype.off=function(type,listener){var listeners=this.listeners[type];if(!listeners)return this;for(var i=0;i<listeners.length;i++)if(listeners[i]===listener){listeners.splice(i,1);break}return this},EventEmiter.prototype.once=function(type,listener){var once,self=this;this.on(type,once=function(){self.off(type,once),listener.call(self,arguments)})},EventEmiter.prototype.emit=function(type,data,source){var listeners=this.listeners[type];if(listeners)for(var i=0;i<listeners.length;i++)(0,listeners[i])({type:type,data:data,source:source||this})},VeloxWebView.prototype=Object.create(EventEmiter.prototype),VeloxWebView.prototype.constructor=VeloxWebView,VeloxWebView.prototype.open=function(data,pCallback){if("function"==typeof data&&(pCallback=data,data=null),pCallback||(pCallback=function(err){if(err)throw console.error("Unexpected error",err),"Unexpected error "+err}),this.opening)return console.warn("You are opening the view "+this.directory+" / "+this.name+" while it is already opening."),this.once("openDone",function(){this.open(data,pCallback)}.bind(this));this.opening=!0;var callback=function(err){this.opening=!1,pCallback(err)}.bind(this);if(this.initDone){if(this.container&&document.documentElement.contains(this.container))return this.bindObject=data,this.render(callback);this.container=null,this.close()}return this.container=this.options.container,this.bindObject=data||this.options.bindObject,this.bindPath=this.options.bindPath,this.containerParent=this.options.containerParent,this.staticHTML=this.options.html,this.staticCSS=this.options.css,this.getHTML(function(html){this.ids={},this.parseHTML(html,function(err,parsed){if(err)throw err;var cssStatics=parsed.cssStatics,cssFiles=parsed.cssFiles,functionInView=parsed.functionInView;this._loadCSS(cssStatics,cssFiles,function(){var clonedBody=parsed.xmlDoc.body.cloneNode(!0);this.replaceIds(clonedBody),this.addToContainer(clonedBody,parsed),this.prepareSubView();var calls=[];VeloxWebView.extensions.forEach(function(extension){extension.init&&calls.push(function(cb){if(0===extension.init.length)try{extension.init.bind(this)(),cb()}catch(err){cb(err)}else extension.init.bind(this)(function(err){cb(err)}.bind(this))}.bind(this))}.bind(this)),asyncSeries(calls,function(err){if(err)return callback(err);functionInView&&functionInView(this),this.initAutoEmit(),this.initDone=!0,this.emit("initDone"),this.render(function(err){if(err)return callback(err);this.show(),this.mustHide&&(this.hide(),this.mustHide=!1),callback(),this.emit("openDone",{view:this})}.bind(this))}.bind(this))}.bind(this))}.bind(this))}.bind(this)),this},VeloxWebView.prototype.addToContainer=function(clonedBody,parsedHTML){if("string"==typeof this.container&&(this.containerId=this.container,this.container=document.getElementById(this.container)),this.container){if(this.container.style.display="none",this.options.containerIsInside&&this.container.id){this.container.setAttribute("data-original-id",this.container.id);var modifiedId=this.container.id+"_-_"+uuidv4();this.ids[this.container.id]=modifiedId,this.container.id=modifiedId}this.container.innerHTML=clonedBody.innerHTML}else{if(!this.containerParent)throw this.containerId+" is not found";if(1===parsedHTML.childrenCount)this.container=clonedBody.firstChild;else{var div=document.createElement("DIV");div.appendChild(clonedBody),this.container=div}this.containerId&&(this.container.id=this.containerId),"string"==typeof this.containerParent&&(this.containerParent=document.getElementById(this.containerParent)),this.container.style.display="none",insertChild(this.containerParent,this.container,this.options.insertBefore,this.options.insertAfter)}},VeloxWebView.prototype.replaceIds=function(bodyNode){for(var elWithId=bodyNode.querySelectorAll("[id]"),i=0;i<elWithId.length;i++){var el=elWithId[i],id=el.id,uuidEl=uuidv4();if("#"===id[0])id=id.substring(1),this.ids[id]=id,el.id=id;else{var modifiedId=id+"_-_"+uuidEl;this.ids[id]=modifiedId,el.id=modifiedId,el.setAttribute("data-original-id",id);for(var elTarget=bodyNode.querySelectorAll('[data-target="#'+id+'"]'),y=0;y<elTarget.length;y++)elTarget[y].setAttribute("data-target","#"+modifiedId);for(var elHref=bodyNode.querySelectorAll('[href="#'+id+'"]'),y=0;y<elHref.length;y++)elHref[y].setAttribute("href","#"+modifiedId);for(var elFor=bodyNode.querySelectorAll('[for="'+id+'"]'),y=0;y<elFor.length;y++)elFor[y].setAttribute("data-target",modifiedId)}}},VeloxWebView.prototype.replacePaths=function(bodyNode){for(var elImg=bodyNode.querySelectorAll("img"),i=0;i<elImg.length;i++){var el=elImg[i];el.setAttribute("src",this.directory+"/"+el.getAttribute("src"))}},VeloxWebView.prototype.hide=function(){this.container&&this.initDone?(this.container.style.display="none",this.emit("hidden")):this.mustHide=!0},VeloxWebView.prototype.show=function(){this.container&&(this.container.style.display="",this.emit("displayed",{view:this}))},VeloxWebView.prototype.elementsHavingAttribute=function(attributeName,withIgnore){var elements=Array.prototype.slice.apply(this.container.querySelectorAll("["+attributeName+"]"));if(this.container.hasAttribute(attributeName)&&elements.push(this.container),elements.length>0){var blockToIgnore=this.container.querySelectorAll("[data-dont-process]");blockToIgnore.length>0&&(elements=elements.filter(function(el){for(var toIgnore=!1,y=0;y<blockToIgnore.length;y++){var bl=blockToIgnore[y];if(bl===el||bl.contains(el)){toIgnore=!0;break}}return!toIgnore}))}return elements},VeloxWebView.prototype.close=function(){this.emit("close"),!this.options.container&&this.options.containerParent&&this.containerParent&&this.container?this.containerParent.removeChild(this.container):this.container&&(this.container.innerHTML=""),this.ids=null,this.views={},this.elements=null,this.initDone=!1,this.boundElements=null},VeloxWebView.prototype.getBoundObject=function(){return pathExtract(this.bindObject,this.bindPath)},VeloxWebView.prototype.pathExtract=function(obj,path,getParent){return pathExtract(obj,path,getParent)},VeloxWebView.prototype.getHTML=function(callback){if(this.staticHTML)callback(this.staticHTML);else{var htmlUrl=this.directory+"/"+this.name+".html";this.getXHR(htmlUrl,callback)}},VeloxWebView.prototype.getXHR=function(url,callback){var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.onload=function(){200===xhr.status?callback.bind(this)(xhr.responseText):callback.bind(this)("Request to "+url+" failed.  Returned status of "+xhr.status)}.bind(this),xhr.send()},VeloxWebView.prototype.parseHTML=function(htmlOfView,callback){var parsed=parsedHTMLCache[htmlOfView];if(parsed)return callback(null,parsed);var html=htmlOfView.replace(/data-original-id=['"]{1}[^'"]*['"]{1}/g,""),cssStatics=[];this.staticCSS&&cssStatics.push(this.staticCSS);var cssFiles=[],functionInView=null,calls=[],xmlDoc=(new DOMParser).parseFromString(html,"text/html");if(xmlDoc.head.children.length>0)for(var child=xmlDoc.head.children[0],scriptIndex=0;child&&("SCRIPT"===child.tagName||"STYLE"===child.tagName);){if("SCRIPT"===child.tagName)if(child.hasAttribute("data-file"))(function(child){var jsPath=child.getAttribute("data-file");calls.push(function(cb){var jsUrl=this.directory+"/"+jsPath;this.getXHR(jsUrl,function(contents){var scriptBody=contents;scriptBody+="//# sourceURL=/"+this.directory+"/"+jsPath,functionInView=new Function("view",scriptBody),scriptIndex++,cb()})}.bind(this))}).bind(this)(child);else{var scriptBody=child.innerHTML;scriptBody+="//# sourceURL=/"+this.directory+"/"+this.name+(scriptIndex>0?"_"+scriptIndex:"")+".js",functionInView=new Function("view",scriptBody),scriptIndex++}else"STYLE"===child.tagName&&(child.hasAttribute("data-file")?cssFiles.push(child.getAttribute("data-file")):cssStatics.push(child.innerHTML));child=child.nextElementSibling}this.replacePaths(xmlDoc.body),asyncSeries(calls,function(err){if(err)return callback(err);parsed={childrenCount:xmlDoc.body.children.length,xmlDoc:xmlDoc,cssStatics:cssStatics,cssFiles:cssFiles,functionInView:functionInView},parsedHTMLCache[htmlOfView]=parsed,callback(null,parsed)})},VeloxWebView.loadStaticCss=function(css){if(!loadedCss[css]){var head=document.getElementsByTagName("head")[0],s=document.createElement("style");s.setAttribute("type","text/css"),s.styleSheet?s.styleSheet.cssText=css:s.appendChild(document.createTextNode(css)),head.appendChild(s),loadedCss[css]=!0}},VeloxWebView.prototype.loadStaticCss=VeloxWebView.loadStaticCss,VeloxWebView.prototype._loadCSS=function(cssStrings,cssFiles,callback){var calls=[];cssStrings.forEach(function(cssContent){this.loadStaticCss(cssContent)}.bind(this)),cssFiles.forEach(function(cssFile){calls.push(function(cb){this.loadCSSFile(cssFile,cb)}.bind(this))}.bind(this)),asyncSeries(calls,callback)},VeloxWebView.prototype.loadCSSFile=function(file,callback){var cssUrl=convertRelativeToAbsolutePath(this.directory,file);if(loadedCss[cssUrl])callback();else{var xhr=new XMLHttpRequest;xhr.open("GET",cssUrl),xhr.onreadystatechange=function(){if(xhr.readyState===XMLHttpRequest.DONE)if(404!==xhr.status){var link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=cssUrl,link.addEventListener("load",function(){callback()},!1),document.getElementsByTagName("head")[0].appendChild(link)}else callback()}.bind(this),xhr.onabort=function(){callback()},xhr.onerror=function(){callback()},xhr.send(),loadedCss[cssUrl]=!0}},VeloxWebView.prototype.ensureInit=function(callback){this.initDone?callback():this.once("initDone",callback)},VeloxWebView.prototype._addSubView=function(el){if(!Object.keys(this.views).some(function(k){return this.views[k].el===el}.bind(this))){var viewId=el.getAttribute("data-view-id");viewId||((viewId=el.id)||(viewId="v_"+uuidv4()),el.setAttribute("data-view-id",viewId));for(var nextElementInParent=el.nextElementSibling,nextElementIds=[];nextElementInParent;)nextElementInParent.hasAttribute("data-vieworder-id")||nextElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),nextElementIds.push(nextElementInParent.getAttribute("data-vieworder-id")),nextElementInParent=nextElementInParent.nextElementSibling;for(var previousElementInParent=el.previousElementSibling,previousElementIds=[];previousElementInParent;)previousElementInParent.hasAttribute("data-vieworder-id")||previousElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),previousElementIds.push(previousElementInParent.getAttribute("data-vieworder-id")),previousElementInParent=previousElementInParent.previousElementSibling;if(!this.views[viewId]){var viewAttr=el.getAttribute("data-view"),bindAttr=el.getAttribute("data-bind"),showIfAttr=el.getAttribute("data-show-if"),hideIfAttr=el.getAttribute("data-hide-if"),dir=this.directory;if(viewAttr){var lastSlash=viewAttr.lastIndexOf("/"),file=viewAttr;-1!==lastSlash&&(dir=viewAttr.substring(0,lastSlash),file=viewAttr.substring(lastSlash+1)),this.views[viewId]={elParent:el.parentElement,el:el,isBefore:nextElementIds.length>0?nextElementIds:null,isAfter:previousElementIds.length>0?previousElementIds:null,bindPath:bindAttr,dir:dir,file:file,showIf:showIfAttr,hideIf:hideIfAttr,instances:[]}}else this.views[viewId]={elParent:el.parentElement,el:el,isBefore:nextElementIds.length>0?nextElementIds:null,isAfter:previousElementIds.length>0?previousElementIds:null,bindPath:bindAttr,dir:dir,html:el.outerHTML,showIf:showIfAttr,hideIf:hideIfAttr,instances:[]}}}},VeloxWebView.prototype.prepareSubView=function(){var i,el,elementsSubs=[],elementsShowIf=this.container.querySelectorAll("[data-show-if]");for(i=0;i<elementsShowIf.length;i++)elementsSubs.push(elementsShowIf[i]);var elementsHideIf=this.container.querySelectorAll("[data-hide-if]");for(i=0;i<elementsHideIf.length;i++)elementsSubs.push(elementsHideIf[i]);var elements=this.container.querySelectorAll("[data-bind]");for(i=0;i<elements.length;i++)(el=elements[i]).getAttribute("data-bind").replace(/\s/g,"").match(/\[\]$/)&&elementsSubs.push(el);var elementsView=this.container.querySelectorAll("[data-view]");for(i=0;i<elementsView.length;i++)elementsSubs.push(elementsView[i]);if(elementsSubs.length>0){var blockToIgnore=this.container.querySelectorAll("[data-dont-process]");blockToIgnore.length>0&&(elementsSubs=elementsSubs.filter(function(el){for(var toIgnore=!1,y=0;y<blockToIgnore.length;y++){var bl=blockToIgnore[y];if(bl===el||bl.contains(el)){toIgnore=!0;break}}return!toIgnore}))}for(elementsSubs.forEach(function(el){for(var nextElementInParent=el.nextElementSibling;nextElementInParent;)nextElementInParent.hasAttribute("data-vieworder-id")||nextElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),nextElementInParent=nextElementInParent.nextElementSibling;for(var previousElementInParent=el.previousElementSibling;previousElementInParent;)previousElementInParent.hasAttribute("data-vieworder-id")||previousElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),previousElementInParent=previousElementInParent.previousElementSibling}),i=0;i<elementsSubs.length;i++){for(var parent=(el=elementsSubs[i]).parentElement,isAlreadyInSubView=!1;parent&&parent!==this.container;){if(-1!==elementsSubs.indexOf(parent)){isAlreadyInSubView=!0;break}parent=parent.parentElement}var elementsSubViews=Array.prototype.slice.apply(el.querySelectorAll("[data-original-id]"));el.hasAttribute("data-original-id")&&elementsSubViews.push(el),elementsSubViews.forEach(function(elInner,z){if((elInner=elementsSubViews[z]).id=elInner.getAttribute("data-original-id"),elInner.id){elInner.removeAttribute("data-original-id");var fakeEl={id:elInner.id,el:el,listeners:{},addEventListener:function(event,listener){this.listeners[event]||(this.listeners[event]=[]),this.listeners[event].push(listener)},isFake:!0};HTMLELEMENT_PROTO_KEYS.forEach(function(k){-1===Object.keys(fakeEl).indexOf(k)&&("function"==typeof elInner[k]?fakeEl[k]=function(){if(fakeEl.realEl)return fakeEl.realEl[k].apply(fakeEl.realEl,arguments)}:Object.defineProperty(fakeEl,k,{get:function(){return fakeEl.realEl?fakeEl.realEl[k]:null},set:function(value){fakeEl.realEl&&(fakeEl.realEl[k]=value)}}))}),this.innerViewIds.push(fakeEl)}}.bind(this)),isAlreadyInSubView||this._addSubView(el)}Object.keys(this.views).forEach(function(viewId){this.views[viewId].elParent.removeChild(this.views[viewId].el)}.bind(this))},VeloxWebView.prototype._transformData=function(callback){if(!this.options.transformData)return callback();if(1===this.options.transformData.length)try{var transformed=this.options.transformData(this.bindObject);if(!transformed)return callback("The transformData function should return the modified value");this.bindObject=transformed,callback()}catch(err){callback(err)}else 1===this.options.transformData.length?this.options.transformData(this.bindObject,function(err,transformed){return err?callback(err):transformed?(this.bindObject=transformed,void callback()):callback("The transformData function should give back the modified value on callback (err, modifiedValue)")}):callback("The transformData function should take argument (data) or (data, callback)")},VeloxWebView.prototype.getSubView=function(idSubView){if(!this.views[idSubView])throw"The subview "+idSubView+" does not exists in view "+this.name+", make sure you add an id attribute on the containing element";return this.views[idSubView].instances[0]},VeloxWebView.prototype.render=function(dataToRender,callbackParam){this.ensureInit(function(){if(this.elements=null,"function"==typeof dataToRender&&(callbackParam=dataToRender,dataToRender=void 0),void 0!==dataToRender&&(this.bindPath?pathSetValue(this.bindObject,this.bindPath,dataToRender):this.bindObject=dataToRender),callbackParam||(callbackParam=function(){}),this.rendering)return callbackParam();this.rendering=!0;var callback=function(err){if(this.rendering=!1,err)return callbackParam(err);callbackParam()}.bind(this);if(!this.boundElements){this.boundElements=[];var allElements=Array.prototype.slice.apply(this.container.getElementsByTagName("*"));allElements.push(this.container),allElements.forEach(function(el){var bindPath=el.getAttribute("data-bind"),bindEl={el:el},isContainerOfNestedView=!1;el===this.container&&(el.getAttribute("data-view")?isContainerOfNestedView=!0:el.children.length>0&&(isContainerOfNestedView=!0)),isContainerOfNestedView||!bindPath||bindPath.replace(/\s/g,"").match(/\[\]$/)||(bindEl.bindPath=bindPath);for(var attributes=el.attributes,boundAttributes={},hasBoundAttribute=!1,i=0;i<attributes.length;i++)-1!==attributes[i].value.indexOf("${")&&-1!==attributes[i].value.indexOf("}")&&(boundAttributes[attributes[i].name]=attributes[i].value,hasBoundAttribute=!0);hasBoundAttribute&&(bindEl.boundAttributes=boundAttributes);for(var textNodes=Array.prototype.slice.apply(el.childNodes).filter(function(n){return n.nodeType===Node.TEXT_NODE}),boundTextNodes={},hasBoundTextNodes=!1,i=0;i<textNodes.length;i++)-1!==textNodes[i].textContent.indexOf("${")&&-1!==textNodes[i].textContent.indexOf("}")&&(boundTextNodes[i]=textNodes[i].textContent,hasBoundTextNodes=!0);hasBoundTextNodes&&(bindEl.boundTextNodes=boundTextNodes),(bindEl.bindPath||bindEl.boundAttributes||bindEl.boundTextNodes)&&this.boundElements.push(bindEl)}.bind(this))}if(!this.bindObject)return callback();this._transformData(function(err){if(err)return callback(err);var baseData=this.bindObject;this.bindPath&&(baseData=pathExtract(this.bindObject,this.bindPath)),this.boundElements.forEach(function(boundEl){var el=boundEl.el,bindPath=boundEl.bindPath;if(bindPath){var fullBindPath=(this.bindPath||"$this")+"."+bindPath;el===this.container&&(fullBindPath=this.bindPath);var bindData=pathExtract(this.bindObject,fullBindPath);if(el.setValue)el.getValue()!=bindData&&el.setValue(bindData);else if("INPUT"===el.tagName||"TEXTAREA"===el.tagName||"SELECT"===el.tagName)if("INPUT"===el.tagName&&"checkbox"===el.type){var checked=!0===bindData||"true"===bindData||"TRUE"===bindData||1===bindData||"1"===bindData;el.checked!==checked&&(el.checked=checked)}else null!==bindData&&void 0!==bindData||(bindData=""),el.value!=bindData&&(el.value=bindData);else null!==bindData&&void 0!==bindData||(bindData=""),"string"==typeof bindData&&/[0-3]{1}[0-9]{3}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}T[0-2]{1}[0-9]{1}:[0-5]{1}[0-9]{1}:[0-5]{1}[0-9]{1}.[0-9]{3}Z/.test(bindData)&&(bindData=new Date(bindData)),/[0-3]{1}[0-9]{3}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}/.test(bindData)&&(bindData=new Date(bindData)),bindData instanceof Date&&(bindData=0===bindData.getHours()&&0===bindData.getMinutes()&&0===bindData.getSeconds()&&0===bindData.getMilliseconds()?bindData.toLocaleDateString?bindData.toLocaleDateString():bindData.toDateString():bindData.toLocaleDateString?bindData.toLocaleDateString()+" "+bindData.toLocaleTimeString():bindData.toDateString()+" "+bindData.toTimeString()),el.textContent!=bindData&&(el.textContent=bindData)}if(boundEl.boundAttributes&&Object.keys(boundEl.boundAttributes).forEach(function(name){for(var originalValue=boundEl.boundAttributes[name],value=originalValue;-1!==value.indexOf("${");){var indexStart=value.indexOf("${"),indexEnd=value.indexOf("}");if(indexEnd<indexStart){console.error("Wrong syntax in "+originalValue);break}var expr=value.substring(indexStart+2,indexEnd),exprValue=evalExpr(baseData,expr);value=value.substring(0,indexStart)+exprValue+value.substring(indexEnd+1)}0===name.indexOf("attr-")&&(name=name.substring(name.indexOf("-")+1)),boundEl.el.getAttribute(name)!=value&&boundEl.el.setAttribute(name,value)}.bind(this)),boundEl.boundTextNodes){var textNodes=Array.prototype.slice.apply(el.childNodes).filter(function(n){return n.nodeType===Node.TEXT_NODE});Object.keys(boundEl.boundTextNodes).forEach(function(index){for(var originalValue=boundEl.boundTextNodes[index],value=originalValue;-1!==value.indexOf("${");){var indexStart=value.indexOf("${"),indexEnd=value.indexOf("}");if(indexEnd<indexStart){console.error("Wrong syntax in "+originalValue);break}var expr=value.substring(indexStart+2,indexEnd),exprValue=evalExpr(baseData,expr);value=value.substring(0,indexStart)+exprValue+value.substring(indexEnd+1)}textNodes[index].textContent!=value&&(textNodes[index].textContent=value)}.bind(this))}var event=document.createEvent("CustomEvent");event.initCustomEvent("bound",!1,!0,{value:bindData,baseData:pathExtract(this.bindObject,this.bindPath),bindPath:bindPath,view:this,data:pathExtract(this.bindObject,(this.bindPath||"$this")+"."+bindPath,!0)}),Object.keys(event.detail).forEach(function(k){event[k]=event.detail[k]}),el.dispatchEvent(event)}.bind(this));var event=document.createEvent("CustomEvent");event.initCustomEvent("bound",!1,!0,{value:this.getBoundObject(),baseData:this.bindObject,bindPath:this.bindPath,view:this,data:pathExtract(this.bindObject,this.bindPath,!0)}),Object.keys(event.detail).forEach(function(k){event[k]=event.detail[k]}),this.container.dispatchEvent(event);var calls=[];Object.keys(this.views).forEach(function(viewId){calls.push(function(cb){var view=this.views[viewId],bindPath=view.bindPath||"",shouldDisplay=!0;if(view.showIf){var showIfData=evalExpr(baseData,view.showIf);(!showIfData||Array.isArray(showIfData)&&0===showIfData.length)&&(shouldDisplay=!1)}if(view.hideIf){var hideIfData=evalExpr(baseData,view.hideIf);shouldDisplay=!1,hideIfData?hideIfData&&Array.isArray(hideIfData)&&0===hideIfData.length&&(shouldDisplay=!0):shouldDisplay=!0}var bindData=pathExtract(this.bindObject,(this.bindPath||"$this")+"."+bindPath.replace(/\s/g,"").replace(/\[\]$/,""));bindPath.length>0&&"]"===bindPath[bindPath.length-1]&&!bindData&&(shouldDisplay=!1);shouldDisplay?this.renderOneView(viewId,bindData,cb):(view.instances.splice(0).forEach(function(instance){instance.container.parentElement.removeChild(instance.container)}.bind(this)),cb())}.bind(this))}.bind(this)),asyncSeries(calls,function(){this.emit("load"),this.emit("render"),callback()}.bind(this))}.bind(this))}.bind(this))},VeloxWebView.prototype.renderOneView=function(viewId,bindData,callback){var view=this.views[viewId];Array.isArray(bindData)||(bindData=[bindData]);var calls=[];bindData.forEach(function(d,y){calls.push(function(cb){view.instances[y]?(view.instances[y].bindPath&&"]"===view.instances[y].bindPath[view.instances[y].bindPath.length-1]&&(view.instances[y].bindPath=view.instances[y].bindPath.substring(0,view.instances[y].bindPath.lastIndexOf("[")+1)+y+"]"),view.instances[y].bindObject=this.bindObject,view.instances[y].render(cb)):this.addViewInstance(viewId,cb)}.bind(this))}.bind(this)),view.instances.splice(bindData.length).forEach(function(instance){instance.container.parentElement.removeChild(instance.container)}.bind(this)),asyncSeries(calls,function(){callback()}.bind(this))},VeloxWebView.prototype.removeViewInstance=function(viewId,index){this.views[viewId].instances.splice(index,1).forEach(function(instance){instance.container.parentElement.removeChild(instance.container)}.bind(this)),this.emit("viewInstanceRemoved",{viewId:viewId,index:index})},VeloxWebView.prototype.addViewInstance=function(viewId,callback){var view=this.views[viewId],bindPath=view.bindPath||"",isAfter=view.isAfter;if(view.instances.length>0){var lastInstanceContainer=view.instances[view.instances.length-1].container;lastInstanceContainer.hasAttribute("data-vieworder-id")||lastInstanceContainer.setAttribute("data-vieworder-id","v_"+uuidv4()),isAfter=[lastInstanceContainer.getAttribute("data-vieworder-id")]}var parentEl=view.elParent,container=null;view.file&&(container=view.el.cloneNode(),insertChild(view.elParent,container,view.isBefore,isAfter));var viewOptions={containerParent:parentEl,container:container,containerIsInside:!!view.file,insertBefore:view.isBefore,insertAfter:isAfter,html:view.html,css:view.html?"":void 0,bindObject:null,bindPath:(this.bindPath?this.bindPath+".":"")+bindPath.replace(/\s/g,"").replace(/\[\]$/,"["+view.instances.length+"]")},v=new VeloxWebView(view.dir,view.file,viewOptions);v.viewId=viewId,v.parentView=this,view.instances.push(v);var _emit=v.emit;v.emit=function(event,data){_emit.bind(v)(event,data),this.emit(event,data,v)}.bind(this),v.open(function(err){if(err)return callback(err);for(var parents=[],loopV=v;loopV.parentView;)parents.push(loopV.parentView),loopV=loopV.parentView;parents.forEach(function(parent){parent.innerViewIds.forEach(function(innerViewId){v.ids[innerViewId.id]&&v.EL[innerViewId.id]&&!v.EL[innerViewId.id].isFake&&(innerViewId.realEl=v.EL[innerViewId.id],Object.keys(innerViewId.listeners).forEach(function(event){innerViewId.listeners[event].forEach(function(l){v.EL[innerViewId.id].addEventListener(event,l)})}))})}.bind(this)),v.bindObject=this.bindObject,v.render(function(err){if(err)return callback(err);callback(),this.emit("viewInstanceAdded",{viewId:viewId,index:view.instances.length-1})}.bind(this))}.bind(this))},VeloxWebView.prototype.reload=function(callback){this.render(callback)},VeloxWebView.prototype.getData=function(){return this.updateData({})},VeloxWebView.prototype.updateData=function(dataToUpdate){var baseData=dataToUpdate;return void 0===dataToUpdate&&(baseData=pathExtract(this.bindObject,this.bindPath)),baseData||(baseData={}),this.boundElements.forEach(function(boundEl){if(boundEl.bindPath){var el=boundEl.el,bindPath=boundEl.bindPath,value=void 0;el.getValue?value=el.getValue():"INPUT"!==el.tagName&&"TEXTAREA"!==el.tagName&&"SELECT"!==el.tagName||(value="INPUT"===el.tagName&&"checkbox"===el.type?el.checked:el.value),void 0!==value&&pathSetValue(baseData,bindPath,value)}}.bind(this)),Object.keys(this.views).forEach(function(viewId){this._updateDataFromView(viewId,baseData,dataToUpdate)}.bind(this)),baseData},VeloxWebView.prototype._updateDataFromView=function(viewId,baseData,dataObject){var view=this.views[viewId],viewBindPath=view.bindPath;viewBindPath&&(viewBindPath=viewBindPath.replace(/\s/g,"").replace(/\[\]$/,""));var viewData=pathExtract(baseData,viewBindPath);return viewData||pathSetValue(baseData,viewBindPath,viewData=[]),view.instances.forEach(function(instance,i){"]"===instance.bindPath[instance.bindPath.length-1]&&(instance.bindPath=instance.bindPath.substring(0,instance.bindPath.lastIndexOf("[")+1)+i+"]",viewData[i]||(viewData[i]={})),instance.updateData(viewData[i])}.bind(this)),Array.isArray(viewData)&&viewData.length>0&&viewData.splice(view.instances.length),viewData},VeloxWebView.prototype.initAutoEmit=function(){for(var emitters=this.elementsHavingAttribute("data-emit"),i=0;i<emitters.length;i++)(function(i){var el=emitters[i],event=el.getAttribute("data-emit");event||(event="click"),el.addEventListener(event,function(){var id=el.getAttribute("data-original-id");this.emit(id,{data:this.getBoundObject(),currentData:this.getBoundObject(),parentData:pathExtract(this.bindObject,this.bindPath,!0),view:this})}.bind(this))}).bind(this)(i)},VeloxWebView.startWait=function(message){message||(message=this.options?this.options.defaultWaitMessage:null),this.waitCount||(this.showWaiterTimeout=setTimeout(function(){this._showWaiter(message)}.bind(this),this.options&&this.options.waiterDelay?this.options.waiterDelay:300)),this.waitCount||(this.waitCount=0),this.waitCount++},VeloxWebView.prototype.startWait=VeloxWebView.startWait.bind(VeloxWebView),VeloxWebView.endWait=function(){0===--this.waitCount&&(clearTimeout(this.showWaiterTimeout),this._hideWaiter())},VeloxWebView.prototype.endWait=VeloxWebView.endWait.bind(VeloxWebView),VeloxWebView.closeAllWaiters=function(){this.waitCount>0&&(this.waitCount=0,clearTimeout(this.showWaiterTimeout),this._hideWaiter())},VeloxWebView.prototype.closeAllWaiters=VeloxWebView.closeAllWaiters.bind(VeloxWebView),VeloxWebView.info=function(message,callback){window.alert(message),callback&&callback()},VeloxWebView.prototype.info=VeloxWebView.info.bind(VeloxWebView),VeloxWebView.error=VeloxWebView.info.bind(VeloxWebView),VeloxWebView.prototype.error=VeloxWebView.prototype.info,VeloxWebView.endWaitError=function(message,callback){this.endWait(),this.error(message,callback)},VeloxWebView.prototype.endWaitError=VeloxWebView.endWaitError.bind(VeloxWebView),VeloxWebView.longTask=function(doTask,message,callback){"function"==typeof message&&(callback=message,message=null),callback||(callback=function(){}),this.startWait(message),"function"==typeof doTask?doTask(function(error){if(error)return this.endWaitError(error),callback(error);this.endWait(),callback()}.bind(this)):doTask.constructor&&"Promise"===doTask.constructor.name&&doTask.then(function(){this.endWait(),callback()}.bind(this)).catch(function(error){this.endWaitError(error),callback(error)}.bind(this))},VeloxWebView.prototype.longTask=VeloxWebView.longTask.bind(VeloxWebView),VeloxWebView._showWaiter=function(message){this.loadStaticCss("@keyframes velox_spinner { to {transform: rotate(360deg);} }.velox_overlay {     position: fixed;     top: 0;     left: 0;     right: 0;     bottom: 0;     background-color: rgba(0, 0, 0, 0.61);     z-index: 1500;   }.velox_waitmsg {     color: white;     position: absolute;    top: calc(50% + 30px);    left: 0;    width: 100%;    text-align: center;  }.velox_spinner:before {     content: '';    box-sizing: border-box;    position: absolute;    top: 50%;    left: 50%;    width: 20px;    height: 20px;    margin-top: -10px;    margin-left: -10px;    border-radius: 50%;    border: 2px solid #ccc;    border-top-color: #333;    animation: velox_spinner .6s linear infinite;  }"),this.waiterDiv=document.createElement("div"),this.waiterDiv.className="velox_overlay";var spinnerDiv=document.createElement("div");if(spinnerDiv.className="velox_spinner",this.waiterDiv.appendChild(spinnerDiv),message){var msgDiv=document.createElement("div");msgDiv.className="velox_waitmsg",msgDiv.innerHTML=message,this.waiterDiv.appendChild(msgDiv)}document.body.appendChild(this.waiterDiv)},VeloxWebView.prototype._showWaiter=VeloxWebView._showWaiter.bind(VeloxWebView),VeloxWebView._hideWaiter=function(){this.waiterDiv&&(this.waiterDiv.parentElement&&this.waiterDiv.parentElement.removeChild(this.waiterDiv),this.waiterDiv=null)},VeloxWebView.prototype._hideWaiter=VeloxWebView._hideWaiter.bind(VeloxWebView),VeloxWebView.prototype._asyncSeries=asyncSeries,VeloxWebView._asyncSeries=asyncSeries,VeloxWebView.extensions=[],VeloxWebView.registerExtension=function(extension){VeloxWebView.extensions.push(extension),extension.extendsProto&&Object.keys(extension.extendsProto).forEach(function(key){VeloxWebView.prototype[key]=extension.extendsProto[key]}),extension.extendsGlobal&&Object.keys(extension.extendsGlobal).forEach(function(key){VeloxWebView[key]=extension.extendsGlobal[key]});var indexes={};VeloxWebView.extensions.forEach(function(ext,i){indexes[ext.name]=i}),VeloxWebView.extensions.forEach(function(ext){ext.mustRunBefore&&ext.mustRunBefore.forEach(function(other){VeloxWebView.extensions.forEach(function(extOther){extOther.name===other&&(extOther.mustRunAfter||(extOther.mustRunAfter=[]),extOther.mustRunAfter.push(ext.name))})})});for(var changed=!0,security=10;changed;)if(changed=!1,VeloxWebView.extensions.forEach(function(ext){ext.mustRunAfter&&ext.mustRunAfter.forEach(function(other){indexes[other]&&indexes[ext.name]<=indexes[other]&&(indexes[ext.name]=indexes[other]+1,changed=!0)})}),--security<=0){console.warn("There is a loop in extensions order before/after, the order is not guaranteed");break}VeloxWebView.extensions=VeloxWebView.extensions.sort(function(e1,e2){return indexes[e1.name]-indexes[e2.name]})},VeloxWebView}),function(global,undefined){"use strict";function clearImmediate(handle){delete tasksByHandle[handle]}function run(task){var callback=task.callback,args=task.args;switch(args.length){case 0:callback();break;case 1:callback(args[0]);break;case 2:callback(args[0],args[1]);break;case 3:callback(args[0],args[1],args[2]);break;default:callback.apply(undefined,args)}}function runIfPresent(handle){if(currentlyRunningATask)setTimeout(runIfPresent,0,handle);else{var task=tasksByHandle[handle];if(task){currentlyRunningATask=!0;try{run(task)}finally{clearImmediate(handle),currentlyRunningATask=!1}}}}if(!global.setImmediate){var registerImmediate,nextHandle=1,tasksByHandle={},currentlyRunningATask=!1,doc=global.document,attachTo=Object.getPrototypeOf&&Object.getPrototypeOf(global);attachTo=attachTo&&attachTo.setTimeout?attachTo:global,"[object process]"==={}.toString.call(global.process)?registerImmediate=function(handle){process.nextTick(function(){runIfPresent(handle)})}:function(){if(global.postMessage&&!global.importScripts){var postMessageIsAsynchronous=!0,oldOnMessage=global.onmessage;return global.onmessage=function(){postMessageIsAsynchronous=!1},global.postMessage("","*"),global.onmessage=oldOnMessage,postMessageIsAsynchronous}}()?function(){var messagePrefix="setImmediate$"+Math.random()+"$",onGlobalMessage=function(event){event.source===global&&"string"==typeof event.data&&0===event.data.indexOf(messagePrefix)&&runIfPresent(+event.data.slice(messagePrefix.length))};global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),registerImmediate=function(handle){global.postMessage(messagePrefix+handle,"*")}}():global.MessageChannel?function(){var channel=new MessageChannel;channel.port1.onmessage=function(event){runIfPresent(event.data)},registerImmediate=function(handle){channel.port2.postMessage(handle)}}():doc&&"onreadystatechange"in doc.createElement("script")?function(){var html=doc.documentElement;registerImmediate=function(handle){var script=doc.createElement("script");script.onreadystatechange=function(){runIfPresent(handle),script.onreadystatechange=null,html.removeChild(script),script=null},html.appendChild(script)}}():registerImmediate=function(handle){setTimeout(runIfPresent,0,handle)},attachTo.setImmediate=function(callback){"function"!=typeof callback&&(callback=new Function(""+callback));for(var args=new Array(arguments.length-1),i=0;i<args.length;i++)args[i]=arguments[i+1];var task={callback:callback,args:args};return tasksByHandle[nextHandle]=task,registerImmediate(nextHandle),nextHandle++},attachTo.clearImmediate=clearImmediate}}("undefined"==typeof self?"undefined"==typeof global?this:global:self),function(global,factory){if("object"==typeof exports&&"undefined"!=typeof module){var VeloxScriptLoader=require("velox-scriptloader");module.exports=factory(VeloxScriptLoader)}else"function"==typeof define&&define.amd?define(["VeloxScriptLoader"],factory):global.VeloxWebView.registerExtension(factory(global.veloxScriptLoader))}(this,function(VeloxScriptLoader){"use strict";function loadW2ui(callback){if(w2utils)callback(null,w2utils);else{if(console.debug("No W2UI object given, we will load from CDN/bower. If you don't want this, include W2UI "+W2UI_VERSION+" in your import scripts or give w2utils object to VeloxWebView.waiter.configure function"),!VeloxScriptLoader)return callback("To have automatic script loading, you need to import VeloxScriptLoader");VeloxScriptLoader.load(W2UI_LIB,function(err){if(err)return callback(err);w2utils=window.w2utils,w2alert=window.w2alert,w2confirm=window.w2confirm,w2prompt=window.w2prompt,w2popup=window.w2popup,callback(null,w2utils)})}}var W2UI_VERSION="1.5.rc1",W2UI_LIB=[{name:"jquery",type:"js",version:"3.2.1",cdn:"//code.jquery.com/jquery-$VERSION.min.js",bowerPath:"jquery/dist/jquery.min.js"},{name:"w2ui-css",type:"css",version:W2UI_VERSION,cdn:"//rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.css",bowerPath:"w2ui/dist/w2ui.min.css"},{name:"w2ui-js",type:"js",version:W2UI_VERSION,cdn:"//rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.js",bowerPath:"w2ui/dist/w2ui.js"}],w2utils=window.w2utils,w2alert=window.w2alert,w2confirm=window.w2confirm,w2prompt=window.w2prompt,w2popup=window.w2popup,confirmNoLabel=null,confirmYesLabel=null,extension={};return extension.name="dialogs",extension.init=function(callback){loadW2ui(callback)},extension.extendsProto={},extension.extendsProto.info=function(message,callback){loadW2ui(function(){w2alert(message,"&nbsp;",callback)}.bind(this))},extension.extendsProto.error=function(message,callback){"object"==typeof message&&(console.error("unexpected error",message),message=message&&message instanceof Error?this.tr?this.tr("global.unexpectedError",{err:message.message+"\n"+message.stack}):message.message+"\n"+message.stack:this.tr?this.tr("global.unexpectedError",{err:JSON.stringify(message)}):JSON.stringify(message)),loadW2ui(function(){w2alert(message,"&nbsp;",function(){window.jQuery("#w2ui-popup").css("box-shadow","0 0 25px #555"),callback&&callback()}),window.jQuery("#w2ui-popup").css("box-shadow","0 0 25px rgba(255, 48, 0, 0.75")})},extension.extendsProto.openInPopup=function(options,callback){"function"==typeof options&&(callback=options,options=null),options||(options={}),callback||(callback=function(){}),options.keyboard=options.closeWithEsc,options.onOpen=callback;var popup=null;this.closePopup=function(){popup&&popup.close()},this.close=function(){VeloxWebView.prototype.close.apply(this),this.closePopup()},this.options.container=document.createElement("DIV"),this.open(function(err){if(err)return callback(err);options.body='<div id="velox_popup_body"></div>',options.width||(options.width=window.jQuery(this.options.container).width()),options.height||(options.height=window.jQuery(this.options.container).height()+32),options.title||(options.title="&nbsp;"),options.onOpen=function(ev){ev.onComplete=function(){document.getElementById("velox_popup_body").appendChild(this.options.container),callback()}.bind(this)}.bind(this),loadW2ui(function(){popup=w2popup.open(options)})}.bind(this))},extension.extendsProto.popup=function(htmlOrElement,options,callback){if("function"==typeof options&&(callback=options,options=null),options||(options={}),callback||(callback=function(){}),options.keyboard=options.closeWithEsc,options.onOpen=callback,!options.width){var windowWidth=window.innerWidth;options.width=windowWidth>1e3?windowWidth/2:windowWidth>500?.66*windowWidth:windowWidth-30}if("object"==typeof htmlOrElement)loadW2ui(function(){window.jQuery(htmlOrElement).w2popup(options)});else{var container=document.createElement("DIV");document.body.appendChild(container),new VeloxWebView(null,null,{container:container,html:htmlOrElement,css:""}).openInPopup(options,callback)}},extension.extendsProto.confirm=function(message,options,callback){"function"==typeof options&&(callback=options,options={}),options||(options={});var labelYes=options.yesLabel||confirmYesLabel;labelYes||(labelYes=VeloxWebView.tr?VeloxWebView.tr("global.yes"):"Yes");var labelNo=options.noLabel||confirmNoLabel;labelNo||(labelNo=VeloxWebView.tr?VeloxWebView.tr("global.no"):"No"),loadW2ui(function(){w2confirm({msg:message,title:"&nbsp;",focus_to_no:options.focusToNoButton,btn_yes:{text:labelYes,callBack:function(){callback(!0)}},btn_no:{text:labelNo,callBack:function(){callback(!1)}}})})},extension.extendsGlobal={},extension.extendsGlobal.dialogs={},extension.extendsGlobal.dialogs.configure=function(options){options.w2utils&&(w2utils=options.w2utils),options.w2alert&&(w2alert=options.w2alert),options.w2confirm&&(w2confirm=options.w2confirm),options.w2prompt&&(w2prompt=options.w2prompt),options.w2popup&&(w2popup=options.w2popup),options.confirmYesLabel&&(confirmYesLabel=options.confirmYesLabel),options.confirmNoLabel&&(confirmNoLabel=options.confirmNoLabel)},extension.extendsGlobal.info=extension.extendsProto.info,extension.extendsGlobal.error=extension.extendsProto.error,extension.extendsGlobal.confirm=extension.extendsProto.confirm,extension.extendsGlobal.popup=extension.extendsProto.popup,extension}),function(global,factory){if("object"==typeof exports&&"undefined"!=typeof module){var VeloxScriptLoader=require("velox-scriptloader"),VeloxWebView=require("velox-webview");module.exports=factory(VeloxScriptLoader,VeloxWebView)}else"function"==typeof define&&define.amd?define(["VeloxScriptLoader","VeloxWebView"],factory):global.VeloxWebView.registerExtension(factory(global.veloxScriptLoader,global.VeloxWebView))}(this,function(VeloxScriptLoader,VeloxWebView){"use strict";function flatpickerLocaleCode(lang){return-1!==["ar","bg","bn","cat","cs","cy","da","de","eo","es","et","fa","fi","fr","gr","he","hi","hr","hu","id","it","ja","ko","lt","lv","mk","ms","my","nl","no","pa","pl","pt","ro","ru","si","sk","sl","sq","sr","sv","th","tr","uk","vn","zh"].indexOf(lang)?lang:""}function momentLocaleCode(lang){var availableLocales=["af","ar-dz","ar","ar-kw","ar-ly","ar-ma","ar-sa","ar-tn","az","be","bg","bn","bo","br","bs","ca","cs","cv","cy","da","de-at","de-ch","de","dv","el","en-au","en-ca","en-gb","en-ie","en-nz","eo","es-do","es","et","eu","fa","fi","fo","fr-ca","fr-ch","fr","fy","gd","gl","gom-latn","he","hi","hr","hu","hy-am","id","is","it","ja","jv","ka","kk","km","kn","ko","ky","lb","lo","lt","lv","me","mi","mk","ml","mr","ms","ms-my","my","nb","ne","nl-be","nl","nn","pa-in","pl","pt-br","pt","ro","ru","sd","se","si","sk","sl","sq","sr-cyrl","sr","ss","sv","sw","ta","te","tet","th","tlh","tl-ph","tr","tzl","tzm","tzm-latn","uk","ur","uz","uz-latn","vi","x-pseudo","yo","zh-cn","zh-hk","zh-tw"];return lang=lang.replace("_","-").toLowerCase(),-1!==availableLocales.indexOf(lang)?lang:"en-us"}function w2uiLocaleCode(lang){var availableLocales=["az-az","ba-ba","bg-bg","ca-es","de-de","en-gb","en-us","es-es","es-mx","fr-fr","gl-es","hr-hr","hu-hu","id-id","it-it","ja-jp","ko-kr","lt-lt","nl-nl","no-no","pl-pl","pt-br","ru-ru","sk-sk","sl-si","tr-tr","zh-cn"];return lang=lang.replace("_","-").toLowerCase(),-1!==availableLocales.indexOf(lang)?lang:(lang=lang+"-"+lang,-1!==availableLocales.indexOf(lang)?lang:"en-us")}function loadW2uiLibLocale(callback){var lib={name:"w2ui-locale-"+w2uiLocaleCode(currentLocale.lang),type:"json",version:W2UI_VERSION,cdn:"https://cdn.rawgit.com/vitmalina/w2ui/master/src/locale/"+w2uiLocaleCode(currentLocale.lang)+".json",bowerPath:"w2ui/src/locale/"+w2uiLocaleCode(currentLocale.lang)+".json"};loadLib("w2ui-locale-"+currentLocale.lang,W2UI_VERSION,lib,function(err,results){if(err)return callback(err);var langJson=results[0][0];window.w2utils.locale(langJson),callback()})}function loadDateLibLocale(callback){var libPicker={name:"flatpickr-calendar-locale-"+flatpickerLocaleCode(currentLocale.lang),type:"js",version:FLATPICKR_VERSION,cdn:"https://npmcdn.com/flatpickr@$VERSION/dist/l10n/"+flatpickerLocaleCode(currentLocale.lang)+".js",bowerPath:"flatpickr/dist/l10n/"+flatpickerLocaleCode(currentLocale.lang)+".js"},libMoment={name:"moment-locale-"+momentLocaleCode(currentLocale.lang),type:"js",version:MOMENTJS_VERSION,cdn:"https://cdnjs.cloudflare.com/ajax/libs/moment.js/$VERSION/locale/"+momentLocaleCode(currentLocale.lang)+".js",bowerPath:"moment/locale/"+momentLocaleCode(currentLocale.lang)+".js"},calls=[];flatpickerLocaleCode(currentLocale.lang)&&calls.push(function(cb){loadLib("flatpicker-locale-"+currentLocale.lang,FLATPICKR_VERSION,libPicker,cb)}),libs.moment||window.moment||(window.moment={locales:{"en-us":{_longDateFormat:{LTS:"h:mm:ss A",LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D, YYYY",LLL:"MMMM D, YYYY h:mm A",LLLL:"dddd, MMMM D, YYYY h:mm A"}}},defineLocale:function(code,localeDef){localeDef._longDateFormat=localeDef.longDateFormat,this.locales[code]=localeDef},localeData:function(code){return this.locales[code]}},libs.moment=window.moment),libs.moment.localeData(momentLocaleCode(currentLocale.lang))||(window.moment||(window.moment=libs.moment),calls.push(function(cb){loadLib("moment-locale-"+momentLocaleCode(currentLocale.lang),MOMENTJS_VERSION,libMoment,cb)})),series(calls,callback)}function doInitView(callback){var view=this,calls=[];this.elementsHavingAttribute("data-field").forEach(function(element){calls.push(function(cb){var fieldType=element.getAttribute("data-field"),fieldSize=element.getAttribute("data-field-size"),fieldOptions={};Array.prototype.slice.call(element.attributes).forEach(function(att){var startIndex="data-field-".length,attKey=att.name;0===attKey.indexOf("data-field")&&attKey.length>startIndex&&(fieldOptions[attKey.substring(startIndex)]=element.getAttribute(attKey))}),createField(view,element,fieldType,fieldSize,fieldOptions,cb)})}),series(calls,callback),this.on("displayed",function(ev){if(ev.data.view===this)for(var grids=this.container.querySelectorAll("[data-field=grid]"),i=0;i<grids.length;i++)grids[i].render()}.bind(this))}function createField(view,element,fieldType,fieldSize,fieldOptions,callback){view.emit("beforeInitField",{id:element.getAttribute("data-original-id"),element:element,fieldType:fieldType,fieldOptions:fieldOptions}),_createField(element,fieldType,fieldSize,fieldOptions,function(err){if(err)return callback(err);decorators.forEach(function(deco){deco(element,fieldType,fieldSize,fieldOptions)}),element.hasAttribute("readonly")&&element.setReadOnly(!0),view.emit("afterInitField",{id:element.getAttribute("data-original-id"),element:element,fieldType:fieldType,fieldOptions:fieldOptions}),callback()})}function _createField(element,fieldType,fieldSize,fieldOptions,callback){"varchar"===fieldType||"text"===fieldType||"string"===fieldType||"password"===fieldType?createTextField(element,fieldType,fieldSize,fieldOptions,callback):"int"===fieldType||"integer"===fieldType||"number"===fieldType||"decimal"===fieldType||"double"===fieldType||"float"===fieldType||"currency"===fieldType||"percent"===fieldType?createNumberField(element,fieldType,fieldSize,fieldOptions,callback):"email"===fieldType?createEmailField(element,fieldType,fieldSize,fieldOptions,callback):-1!==["date","datetime","time","timestamp","timestamptz"].indexOf(fieldType)?createDateField(element,fieldType,fieldSize,fieldOptions,callback):"selection"===fieldType||"select"===fieldType?createSelectField(element,fieldType,fieldSize,fieldOptions,callback):"bool"===fieldType||"boolean"===fieldType||"checkbox"===fieldType||"toggle"===fieldType||"switch"===fieldType?createCheckboxField(element,fieldType,fieldSize,fieldOptions,callback):"grid"===fieldType?createGridField(element,fieldType,fieldSize,fieldOptions,callback):"upload"===fieldType?createUploadField(element,fieldType,fieldSize,fieldOptions,callback):"pdf"===fieldType?createPdfField(element,fieldType,fieldSize,fieldOptions,callback):callback("Unknow field type "+fieldType)}function loadLib(name,version,libDef,callback){if(libs[name])callback();else{if(window[name])return libs[name]=window[name],callback();if(console.debug("No "+name+" object given, we will load from CDN/bower. If you don't want this, add the lib "+name+" (version "+version+") in your global import scripts or give "+name+" object to VeloxWebView.field.configure({libs : { "+name+": __here__ }})"),!VeloxScriptLoader)return callback("To have automatic script loading, you need to import VeloxScriptLoader");VeloxScriptLoader.load(libDef,function(err,result){if(err)return callback(err);libs[name]=window[name],callback(null,result)})}}function setReadOnly(element,readOnly){element._veloxIsReadOnly=readOnly;var input=element.getElementsByTagName("input")[0];input?"text"===input.type||"password"===input.type?input.readOnly=readOnly:input.disabled=readOnly:element.getElementsByTagName("select")[0].disabled=readOnly,readOnly?-1===element.className.indexOf("readonly")&&(element.className+=" readonly"):-1!==element.className.indexOf("readonly")&&(element.className=element.className.replace("readonly",""))}function loadInputMask(callback){loadLib("Inputmask",INPUTMASK_VERSION,INPUT_MASK_LIB,function(err){if(err)return callback(err);libs.Inputmask.extendAliases({uppercase:{mask:"*{*}",casing:"upper"},lowercase:{mask:"*{*}",casing:"lower"}}),callback()})}function createTextField(element,fieldType,fieldSize,fieldOptions,callback){var input=appendInputHtml(element);if("password"===fieldType&&(input.type="password"),fieldSize){var fieldSize=parseInt(fieldSize,10);if(isNaN(fieldSize))return callback("Incorrect field size option : "+fieldSize+" on "+elToString(element));input.maxLength=fieldSize}var maskField=null;element.getValue=function(){return maskField?maskField._valueGet():input.value},element.setValue=function(value){input.value=value?""+value:"",maskField&&maskField._valueSet(value)},element.setReadOnly=function(readOnly){setReadOnly(element,readOnly)},element.focus=function(){input.focus()},fieldOptions.mask?loadInputMask(function(err){if(err)return callback(err);var im=new libs.Inputmask(fieldOptions.mask);maskField=im.mask(input),callback()}.bind(this)):callback()}function fillLocales(callback){if("99,99"===99.99.toLocaleString("fr")){var localizedNumber=1000.99.toLocaleString(currentLocale.lang);currentLocale.delimiters.thousands=localizedNumber[1],currentLocale.delimiters.decimal=localizedNumber[5],callback()}else loadLib("numbro",NUMBRO_VERSION,NUMBRO_LIB,function(err){if(err)return callback(err);var numbroLangName=currentLocale.lang,numbroCultures=libs.numbro.cultures();numbroCultures[numbroLangName]||(numbroCultures[numbroLangName+"-"+numbroLangName.toUpperCase()]?numbroLangName=numbroLangName+"-"+numbroLangName.toUpperCase():Object.keys(numbroCultures).some(function(l){if(0===l.indexOf(numbroLangName))return numbroLangName=l,!0})||(numbroLangName="en-US"));var langData=libs.numbro.cultureData(numbroLangName);currentLocale.delimiters.thousands=langData.delimiters.thousands,currentLocale.delimiters.decimal=langData.delimiters.decimal,callback()})}function getLocale(callback){currentLocale?callback():(currentLocale={lang:navigator.language||navigator.userLanguage,delimiters:{}},VeloxWebView.i18n?(currentLocale.lang=VeloxWebView.i18n.getLang(),VeloxWebView.i18n.onLanguageChanged(function(newLang){currentLocale.lang=newLang,fillLocales(function(err){if(err)return console.error("Error while reloading locales",err);console.debug("Locales reloaded")})}),fillLocales(callback)):fillLocales(callback))}function createNumberField(element,fieldType,fieldSize,fieldOptions,callback){var input=appendInputHtml(element),maskField=null,maskOptions=null;element.getValue=function(){if(maskField){var value=maskField._valueGet();return maskOptions&&(value=replaceAll(value,maskOptions.radixPoint,"."),value=replaceAll(value,maskOptions.groupSeparator,""),value=replaceAll(value,maskOptions.prefix,""),value=replaceAll(value,maskOptions.suffix,"")),value=""===value?new libs.Decimal(0):new libs.Decimal(value),"percent"===fieldType&&(value=value.div(100)),value}return input.value},element.setValue=function(value){value||(value=0),value=new libs.Decimal(value),"percent"===fieldType&&(value=value.mul(100)),value=value.toNumber(),input.value=value?""+value:"",maskField&&maskField._valueSet(value)},element.setReadOnly=function(readOnly){setReadOnly(element,readOnly)},["change","focus","blur","keyUp","keyDown"].forEach(function(eventName){input.addEventListener(eventName,function(ev){var cloneEv=new ev.constructor(ev.type,ev);element.dispatchEvent(cloneEv)})}),loadLib("Decimal",DECIMALJS_VERSION,DECIMALJS_LIB,function(err){if(err)return callback(err);loadInputMask(function(err){if(err)return callback(err);"int"===fieldType||"integer"===fieldType||"number"===fieldType?getLocale(function(err){if(err)return callback(err);maskOptions={radixPoint:currentLocale.delimiters.decimal,groupSeparator:currentLocale.delimiters.thousands,prefix:"",suffix:"",positionCaretOnTab:!1};var im=new libs.Inputmask("integer",maskOptions);maskField=im.mask(input),callback()}):"decimal"!==fieldType&&"double"!==fieldType&&"float"!==fieldType&&"percent"!==fieldType&&"currency"!==fieldType||getLocale(function(err){if(err)return callback(err);if(maskOptions={radixPoint:currentLocale.delimiters.decimal,groupSeparator:currentLocale.delimiters.thousands,prefix:"",suffix:"",positionCaretOnTab:!1},fieldOptions.decimaldigits){var digits=parseInt(fieldOptions.decimaldigits,10);if(isNaN(digits))return callback("Invalid value for option decimaldigits, number expected");maskOptions.digits=digits}"percent"===fieldType&&(maskOptions.suffix=" %");var im=new libs.Inputmask("currency",maskOptions);maskField=im.mask(input),callback()})}.bind(this))}.bind(this))}function createEmailField(element,fieldType,fieldSize,fieldOptions,callback){var input=appendInputHtml(element),maskField=null;element.getValue=function(){return maskField?maskField._valueGet():input.value},element.setValue=function(value){input.value=value?""+value:"",maskField&&maskField._valueSet(value)},element.setReadOnly=function(readOnly){setReadOnly(element,readOnly)},["change","focus","blur","keyUp","keyDown"].forEach(function(eventName){input.addEventListener(eventName,function(ev){var cloneEv=new ev.constructor(ev.type,ev);element.dispatchEvent(cloneEv)})}),loadInputMask(function(err){if(err)return callback(err);var im=new libs.Inputmask("email");maskField=im.mask(input),callback()}.bind(this))}function createDateField(element,fieldType,fieldSize,fieldOptions,callback){var input=appendInputHtml(element),maskField=null,pickrField=null;element.getValue=function(){var value=null;return pickrField&&pickrField.selectedDates.length>0&&(value=pickrField.selectedDates[0]),value},element.setValue=function(value){pickrField.setDate(value,!1)},element.setReadOnly=function(readOnly){setReadOnly(element,readOnly)},["change","focus","blur","keyUp","keyDown"].forEach(function(eventName){input.addEventListener(eventName,function(ev){var cloneEv=new ev.constructor(ev.type,ev);element.dispatchEvent(cloneEv)})}),loadLib("flatpickr",FLATPICKR_VERSION,FLATPICKR_LIB,function(err){if(err)return callback(err);loadInputMask(function(err){if(err)return callback(err);getLocale(function(err){if(err)return callback(err);loadDateLibLocale(function(err){if(err)return callback(err);var localeData=libs.moment.localeData(momentLocaleCode(currentLocale.lang)),localeDateFormat=localeData._longDateFormat.L;-1!==["datetime","timestamp","timestamptz"].indexOf(fieldType)?localeDateFormat=localeData._longDateFormat.L+" "+localeData._longDateFormat.LT:"time"===fieldType&&(localeDateFormat=localeData._longDateFormat.LT);var useAMPM=-1!==localeData._longDateFormat.LT.indexOf("A"),flatpickrOptions={allowInput:!0,dateFormat:localeDateFormat.replace("YYYY","Y").replace("YY","y").replace("DD","d").replace("MM","m").replace("HH","H").replace("mm","i").replace("A","K"),enableTime:-1!==fieldType.indexOf("time"),noCalendar:"time"===fieldType,time_24hr:!useAMPM};flatpickerLocaleCode(currentLocale.lang)&&(flatpickrOptions.locale=flatpickerLocaleCode(currentLocale.lang)),pickrField=libs.flatpickr(input,flatpickrOptions);var maskFormat=localeDateFormat.toLowerCase();"datetime"===fieldType||"timestamp"===fieldType||"timestamptz"===fieldType?(maskFormat="datetime",useAMPM&&(maskFormat="datetime12",0===localeDateFormat.indexOf("MM")&&(maskFormat="mm/dd/yyyy hh:mm xm"))):"time"===fieldType&&(maskFormat="hh:mm",useAMPM&&(maskFormat="hh:mm t"));var im=new libs.Inputmask(maskFormat,{placeholder:"_"});maskField=im.mask(input),input.addEventListener("blur",function(){pickrField.setDate(maskField._valueGet(),!1)}),callback()}.bind(this))}.bind(this))}.bind(this))}.bind(this))}function loadSwitchCSS(){if(!switchCSSLoaded){var css="/* The switch - the box around the slider */";css+=".switch { position: relative; display: inline-block; width: 60px; height: 34px; }",css+="/* Hide default HTML checkbox */",css+=".switch input {display:none;}",css+="/* The slider */",css+=".slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; -webkit-transition: .4s; transition: .4s; }",css+='.slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; -webkit-transition: .4s; transition: .4s; }',css+="input:checked + .slider { background-color: #2196F3; }",css+="input:focus + .slider { box-shadow: 0 0 1px #2196F3; }",css+="input:checked + .slider:before { -webkit-transform: translateX(26px); -ms-transform: translateX(26px); transform: translateX(26px); }",css+="/* Rounded sliders */",css+=".slider.round { border-radius: 34px; }",css+=".slider.round:before { border-radius: 50%; }";var head=document.getElementsByTagName("head")[0],s=document.createElement("style");s.setAttribute("type","text/css"),s.styleSheet?s.styleSheet.cssText=css:s.appendChild(document.createTextNode(css)),head.appendChild(s),switchCSSLoaded=!0}}function loadSelectCSS(){if(!selectCSSLoaded){var css=".selectize-input.locked, .selectize-control.single .selectize-input.input-active.locked { background: #eeeeee; }";css+=".selectize-control.single .selectize-input.locked:after{ display: none }";var head=document.getElementsByTagName("head")[0],s=document.createElement("style");s.setAttribute("type","text/css"),s.styleSheet?s.styleSheet.cssText=css:s.appendChild(document.createTextNode(css)),head.appendChild(s),selectCSSLoaded=!0}}function createSelectField(element,fieldType,fieldSize,fieldOptions,callback){loadLib("selectize",SELECTIZE_VERSION,SELECTIZE_LIB,function(err){if(err)return callback(err);window.Selectize.prototype.positionDropdown=function(){var $control=this.$control,offset="body"===this.settings.dropdownParent?$control.offset():$control.position(),controlHeight=$control.outerHeight(!0),dropdownHeight=this.$dropdown.outerHeight(!0),optDirection="auto";"auto"===optDirection&&(optDirection=$control.offset().top+controlHeight+dropdownHeight<window.jQuery(window).height()?"down":"up"),"down"===optDirection?(offset.top+=controlHeight,self.isDropUp=!1):"up"===optDirection&&(offset.top-=dropdownHeight,self.isDropUp=!0),this.$dropdown.css({width:$control.outerWidth(),top:offset.top,left:offset.left})},loadSelectCSS();var select=null;if("SELECT"===element.tagName)select=element;else{var subSelects=element.getElementsByTagName("SELECT");if(0===subSelects.length)return callback("Your data field select should be a SELECT tag or contain a SELECT tag");select=subSelects[0]}var $select=window.jQuery(select);$select.selectize();var selectize=$select[0].selectize;selectize.setValue(""),element.getValue=function(){return selectize.getValue()||null},element.setValue=function(value){return selectize.setValue(value)},element.setReadOnly=function(readOnly){readOnly?selectize.lock():selectize.unlock()},element.addEventListener=function(event,listener){$select.on(event,function(ev){ev.target=element,listener(ev)})},element.setOptions=function(options){selectize.clearOptions(),selectize.addOption(options)},element.getOptions=function(){return selectize.options},callback()})}function uuidv4(){return void 0!==window.crypto&&crypto.getRandomValues?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(c){return(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)}):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)})}function createGridField(element,fieldType,fieldSize,fieldOptions,callback){var subTables=element.getElementsByTagName("TABLE");if(0===subTables.length)return callback("Your data field grid should contain a TABLE tag");var table=subTables[0],listThead=table.getElementsByTagName("THEAD"),thead=listThead.length>0?listThead[0]:null,toolbar=table.querySelector("[data-toolbar]");toolbar&&toolbar.parentElement.removeChild(toolbar);var listTh=Array.prototype.slice.call(table.getElementsByTagName("TH"));if(0===listTh.length)return callback("Your data field grid should have at least a TH tag");var listTr=Array.prototype.slice.call(table.getElementsByTagName("TR"));loadLib("w2ui",W2UI_VERSION,W2UI_LIB,function(err){if(err)return callback(err);getLocale(function(err){if(err)return callback(err);loadW2uiLibLocale(function(err){if(err)return callback(err);var gridOptions={name:Array.prototype.slice.call(window.jQuery(element).parents()).map(function(p){return p.getAttribute("data-original-id")}).filter(function(c){return!!c}).reverse().join(".")||"grid_"+uuidv4(),textSearch:"contains",columns:[],show:{},searches:[]};["keyboard","recid","markSearch","multiSearch","multiSelect","multiSort","recordHeight","reorderColumns","reorderRows","selectType"].forEach(function(optionAttribute){var optionValue=table.getAttribute(optionAttribute);optionValue&&("false"===optionValue&&(optionValue=!1),"true"===optionValue&&(optionValue=!0),gridOptions[optionAttribute]=optionValue)}),thead&&["header","toolbar","footer","columnHeaders","lineNumbers","expandColumn","selectColumn","emptyRecords","toolbarInput","toolbarReload","toolbarColumns","toolbarSearch","toolbarAdd","toolbarEdit","toolbarDelete","toolbarSave","selectionBorder","recordTitles","skipRecords"].forEach(function(showAttr){var showValue=thead.getAttribute(showAttr);showValue&&(gridOptions.show[showAttr]="true"===showValue.trim().toLowerCase())}),toolbar&&(gridOptions.toolbar={items:[]},gridOptions.show.toolbar=!0,Array.prototype.slice.apply(toolbar.children).forEach(function(item){var toolbarItem={id:item.getAttribute("data-original-id"),text:item.innerHTML};["type","tooltip","count","img","icon","style","group"].forEach(function(k){item.hasAttribute("data-"+k)&&(toolbarItem[k]=item.getAttribute("data-"+k))}),["hidden","hidden","checked"].forEach(function(k){item.hasAttribute("data-"+k)&&(toolbarItem[k]="false"!==item.getAttribute("data-"+k))}),"html"===toolbarItem.type&&(toolbarItem.html=toolbarItem.text,delete toolbarItem.text),gridOptions.toolbar.items.push(toolbarItem)}.bind(this))),0===Object.keys(gridOptions.show).length&&delete gridOptions.show;var totalColsWithSizePx=0,totalColsWithSizePercent=0;listTh.forEach(function(th,i){var colDef={field:th.getAttribute("data-field-name")||"f"+i,size:th.getAttribute("data-field-size")},scriptRender=th.querySelector("script");if(scriptRender){var scriptBody=scriptRender.text;scriptBody+="//# sourceURL=/column/render/"+element.getAttribute("data-original-id")+"/"+colDef.field+".js";var functionRender=new Function("record","index","column_index",scriptBody);colDef.render=functionRender,th.removeChild(scriptRender)}var labelEl=th.querySelector("label");colDef.caption=labelEl?labelEl.innerHTML:th.innerHTML,colDef.size&&(-1===colDef.size.indexOf("px")&&-1===colDef.size.indexOf("%")&&(colDef.size=colDef.size+"px"),-1!==colDef.size.indexOf("px")?totalColsWithSizePx+=parseInt(colDef.size.replace("px",""),10):-1!==colDef.size.indexOf("%")&&(totalColsWithSizePercent+=parseInt(colDef.size.replace("%",""),10))),["sortable","searchable","hidden"].forEach(function(colAtt){var colValue=th.getAttribute(colAtt);null!==colValue&&(colDef[colAtt]="false"!==colValue.trim().toLowerCase())}),void 0===colDef.searchable&&(colDef.searchable=!0),void 0===colDef.sortable&&(colDef.sortable=!0);var type=th.getAttribute("data-field-type");colDef.fieldType=type,!colDef.render&&type&&(colDef.render=createGridRenderer(type,colDef.field)),gridOptions.columns.push(colDef)});var totalColsNoSize=gridOptions.columns.filter(function(c){return!c.size}).length;if(totalColsNoSize>0){var totalWidth=element.offsetWidth-3,defaultColSize="10%";if(0===totalColsWithSizePx){var colPercent=(100-totalColsWithSizePercent)/totalColsNoSize;colPercent>0&&(defaultColSize=colPercent+"%")}else{var colPixel=(totalWidth-totalColsWithSizePercent/100*totalWidth-totalColsWithSizePx)/totalColsNoSize;colPixel>10&&(defaultColSize=colPixel+"px")}gridOptions.columns.forEach(function(c){c.size||(c.size=defaultColSize)})}var records=[],recid=1;listTr.forEach(function(tr){var listTd=Array.prototype.slice.call(tr.getElementsByTagName("TD"));if(listTd.length>0){var record={recid:recid++};listTd.forEach(function(td,i){var value=td.innerHTML;gridOptions.columns[i].fieldType&&(-1!==gridOptions.columns[i].fieldType.indexOf("date")?value=new Date(value):-1!==["int","integer","double","decimal","number"].indexOf(gridOptions.columns[i].fieldType)&&(value=parseFloat(value))),record[gridOptions.columns[i].field]=value}),records.push(record)}}),records.length>0&&(gridOptions.records=records),libs.w2ui[gridOptions.name]&&libs.w2ui[gridOptions.name].destroy(),element.innerHTML="";var grid=window.jQuery(element).w2grid(gridOptions);element.getValue=function(){var records=grid.records.slice();return records.forEach(function(r){delete r.recid}),records},element.setValue=function(value){grid.clear(),value&&(value.forEach(function(d,i){d.recid||(gridOptions.recid?d.recid=d[gridOptions.recid]:d.recid=i)}),grid.add(value))},element.setReadOnly=function(readOnly){console.log("implement read only on grid ?")},element.addEventListener=function(event,listener){grid.on(event,function(ev){ev.recid&&(ev.record=grid.get(ev.recid)),listener(ev)})},Object.keys(Object.getPrototypeOf(grid)).concat(Object.keys(grid)).forEach(function(k){void 0===element[k]&&("function"==typeof grid[k]?element[k]=function(){return grid[k].apply(grid,arguments)}:Object.defineProperty(element,k,{get:function(){return grid[k]}}))}),callback()})})})}function createGridRenderer(type,colName){return-1!==["varchar","text"].indexOf(type)?null:-1!==["int","integer"].indexOf(type)?"int":-1!==["double","float","number","decimal"].indexOf(type)?"number:2":"date"===type||"timestamp"===type?function(record){var dt=record[colName];return"string"==typeof dt&&/[0-3]{1}[0-9]{3}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}T[0-2]{1}[0-9]{1}:[0-5]{1}[0-9]{1}:[0-5]{1}[0-9]{1}.[0-9]{3}Z/.test(dt)&&(dt=new Date(dt)),/[0-3]{1}[0-9]{3}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}/.test(dt)&&(dt=new Date(dt)),dt instanceof Date&&(dt=0===dt.getHours()&&0===dt.getMinutes()&&0===dt.getSeconds()&&0===dt.getMilliseconds()?dt.toLocaleDateString?dt.toLocaleDateString():dt.toDateString():dt.toLocaleDateString?dt.toLocaleDateString()+" "+dt.toLocaleTimeString():dt.toDateString()+" "+dt.toTimeString()),dt}:type}function loadUploadCSS(){if(!uploadCSSLoaded){var css="";css+=".velox-upload-hover { background: rgba(255, 255, 255, 0.45); }";var head=document.getElementsByTagName("head")[0],s=document.createElement("style");s.setAttribute("type","text/css"),s.styleSheet?s.styleSheet.cssText=css:s.appendChild(document.createTextNode(css)),head.appendChild(s),uploadCSSLoaded=!0}}function createUploadField(element,fieldType,fieldSize,fieldOptions,callback){loadUploadCSS();var input=appendInputHtml(element);input.type="file",input.className="velox-upload-input",input.multiple=!!fieldOptions.multiple,Object.defineProperty(element,"accept",{get:function(){return input.accept.split(",")},set:function(accept){Array.isArray(accept)||(accept=accept.split(",")),(accept=accept.slice()).forEach(function(a,i){"."!==a[0]&&(accept[i]="."+a)}),input.accept=accept.join(",")}}),fieldOptions.accept&&(element.accept=fieldOptions.accept),element.addEventListener("dragover",fileDragHover,!1),element.addEventListener("dragleave",fileDragHover,!1),element.addEventListener("drop",fileSelectHandler,!1),input.addEventListener("change",function(){element.setValue(this.files)}),input.addEventListener("click",function(){input.value=""});var fileDragHover=function(e){e.stopPropagation(),e.preventDefault(),"dragover"===e.type?element.classList.contains("velox-upload-hover")||element.classList.add("velox-upload-hover"):element.classList.remove("velox-upload-hover")},selectedFiles=[],fileSelectHandler=function(e){fileDragHover(e),selectedFiles=e.target.files||e.dataTransfer.files};element.getValue=function(){return selectedFiles?input.multiple?selectedFiles:selectedFiles.length>0?selectedFiles[0]:null:null},element.setValue=function(value){value&&!value instanceof FileList&&!Array.isArray(selectedFiles)&&(value=[value]),selectedFiles=value,value||(input.value="")},element.setReadOnly=function(readOnly){setReadOnly(element,readOnly)},callback()}function createCheckboxField(element,fieldType,fieldSize,fieldOptions,callback){var input=null;if("boolean"===fieldType||"bool"===fieldType||"checkbox"===fieldType)(input=appendInputHtml(element)).type="checkbox";else{(input=document.createElement("input")).type="checkbox";var label=document.createElement("label"),slider=document.createElement("span");slider.className="slider round",label.className="switch",label.appendChild(input),label.appendChild(slider),element.innerHTML="",element.appendChild(label),loadSwitchCSS()}element.getValue=function(){return input.checked},element.setValue=function(value){return value=!0===value||"true"===value||"1"===value||"on"===value,input.checked=value},element.setReadOnly=function(readOnly){setReadOnly(element,readOnly)},["change","focus","blur","keyUp","keyDown"].forEach(function(eventName){input.addEventListener(eventName,function(ev){var cloneEv=new ev.constructor(ev.type,ev);element.dispatchEvent(cloneEv)})}),callback()}function createPdfField(element,fieldType,fieldSize,fieldOptions,callback){loadLib("PDFObject",PDFOBJECT_VERSION,PDFOBJECT_LIB,function(err){if(err)return callback(err);var pdfEl=null,currentValue=null;element.getValue=function(){return currentValue},element.setValue=function(value){currentValue=value,pdfEl&&element.removeChild(pdfEl),(pdfEl=document.createElement("div")).style.width="100%",pdfEl.style.height="100%",element.appendChild(pdfEl);var options={};libs.PDFObject.supportsPDFs||("cdn"===VeloxScriptLoader.options.policy?console.warn("This browser does not support PDF and PDF.js viewer cannot be load from CDN because it cannot run remotely"):options.PDFJS_URL=VeloxScriptLoader.options.bowerPath+"velox-view/ext/pdfjs/"+PDFJS_VERSION+"/web/viewer.html");libs.PDFObject.embed(value,pdfEl,options)},element.showPDF=element.setValue,element.setReadOnly=function(){},fieldOptions.pdfurl&&element.setValue(fieldOptions.pdfurl),callback()})}function elToString(element){for(var str=element.tagName,i=0;i<element.attributes.length;i++)str+=" "+element.attributes[i]+' = "'+element.getAttribute(element.attributes[i])+'"';return"["+str+"]"}function appendInputHtml(element){var input=document.createElement("INPUT");return input.type="text",element.innerHTML="",element.appendChild(input),input}var extension={};extension.name="fields",extension.mustRunAfter=["i18n"];var libs={},decorators=[],currentLocale=null,switchCSSLoaded=!1,selectCSSLoaded=!1,uploadCSSLoaded=!1;extension.init=function(cb){var view=this;doInitView.bind(view)(cb)},extension.extendsGlobal={},extension.extendsGlobal.fields={configure:function(options){options.libs&&Object.keys(options.libs).forEach(function(k){libs[k]=options.libs[k]})},addDecorator:function(decorator){decorators.push(decorator)},createField:function(element,fieldType,fieldSize,fieldOptions,callback){createField(this,element,fieldType,fieldSize,fieldOptions,callback)},resetLocale:function(){currentLocale=null}},extension.extendsProto={},extension.extendsProto.setReadOnly=function(readOnly){this.elementsHavingAttribute("data-field").forEach(function(element){element.setReadOnly(readOnly)})};var INPUTMASK_VERSION="3.3.7",NUMBRO_VERSION="1.11.0",DECIMALJS_VERSION="2.2.0",FLATPICKR_VERSION="3.0.5-1",MOMENTJS_VERSION="2.18.1",SELECTIZE_VERSION="0.12.4",W2UI_VERSION="1.5.rc1",PDFOBJECT_VERSION="latest",PDFJS_VERSION="1.9.426",JQUERY_LIB={name:"jquery",type:"js",version:"3.2.1",cdn:"http://code.jquery.com/jquery-$VERSION.min.js",bowerPath:"jquery/dist/jquery.min.js"},INPUT_MASK_LIB=[JQUERY_LIB,{name:"inputmask-bundle",type:"js",version:INPUTMASK_VERSION,cdn:"https://cdn.jsdelivr.net/gh/RobinHerbots/Inputmask@$VERSION/dist/jquery.inputmask.bundle.js",bowerPath:"inputmask/dist/jquery.inputmask.bundle.js"}],NUMBRO_LIB=[{name:"numbro",type:"js",version:NUMBRO_VERSION,cdn:"https://cdnjs.cloudflare.com/ajax/libs/numbro/$VERSION/numbro.min.js",bowerPath:"numbro/dist/numbro.min.js"},{name:"numbro-language",type:"js",version:NUMBRO_VERSION,cdn:"https://cdnjs.cloudflare.com/ajax/libs/numbro/$VERSION/languages.min.js",bowerPath:"numbro/dist/languages.min.js"}],DECIMALJS_LIB=[{name:"decimaljs-light",type:"js",version:DECIMALJS_VERSION,cdn:"https://cdn.jsdelivr.net/gh/MikeMcl/decimal.js-light@$VERSION/decimal.min.js",bowerPath:"decimal.js-light/decimal.min.js"}],FLATPICKR_LIB=[{name:"flatpickr-calendar-css",type:"css",version:FLATPICKR_VERSION,cdn:"https://unpkg.com/flatpickr@$VERSION/dist/flatpickr.min.css",bowerPath:"flatpickr/dist/flatpickr.min.css"},{name:"flatpickr-calendar-js",type:"js",version:FLATPICKR_VERSION,cdn:"https://unpkg.com/flatpickr@$VERSION",bowerPath:"flatpickr/dist/flatpickr.min.js"}],SELECTIZE_LIB=[JQUERY_LIB,{name:"selectize-css",type:"css",version:SELECTIZE_VERSION,cdn:"https://cdnjs.cloudflare.com/ajax/libs/selectize.js/$VERSION/css/selectize.css",bowerPath:"selectize/dist/css/selectize.css"},{name:"selectize-js",type:"js",version:SELECTIZE_VERSION,cdn:"https://cdnjs.cloudflare.com/ajax/libs/selectize.js/$VERSION/js/standalone/selectize.min.js",bowerPath:"selectize/dist/js/standalone/selectize.min.js"}],W2UI_LIB=[JQUERY_LIB,{name:"w2ui-css",type:"css",version:W2UI_VERSION,cdn:"http://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.css",bowerPath:"w2ui/dist/w2ui.min.css"},{name:"w2ui-js",type:"js",version:W2UI_VERSION,cdn:"http://rawgit.com/vitmalina/w2ui/master/dist/w2ui.min.js",bowerPath:"w2ui/dist/w2ui.js"}],PDFOBJECT_LIB=[{name:"pdfobject",type:"js",version:PDFOBJECT_VERSION,cdn:"https://bowercdn.net/c/pdfobject2-$VERSION/pdfobject.min.js",bowerPath:"pdfobject/pdfobject.min.js"}],escapeRegExp=function(str){return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},replaceAll=function(str,find,replace){return str.replace(new RegExp(escapeRegExp(find),"g"),replace)},series=function(calls,callback){if(0===calls.length)return callback();calls=calls.slice();var doOne=function(){calls.shift()(function(err){if(err)return callback(err);0===calls.length?callback():doOne()})};doOne()};return extension}),function(global,factory){if("object"==typeof exports&&"undefined"!=typeof module){var VeloxScriptLoader=require("velox-scriptloader"),VeloxWebView=require("velox-webview");module.exports=factory(VeloxScriptLoader,VeloxWebView)}else"function"==typeof define&&define.amd?define(["VeloxScriptLoader","VeloxWebView"],factory):global.VeloxWebView.registerExtension(factory(global.veloxScriptLoader,global.VeloxWebView))}(this,function(VeloxScriptLoader,VeloxWebView){"use strict";function getSchema(callback){return schema?callback(null,schema):apiClient?void apiClient.__velox_database.getSchema(function(err,schemaFromServer){if(err)return callback(err);(schema=schemaFromServer)&&schemaExtend&&extendsSchema(schema,schemaExtend),callback(null,schema)}):callback(null,null)}function doInitView(callback){if(!VeloxWebView.fields)return callback("You need to load the fields extension to use fields schema extension");var calls=[];this.elementsHavingAttribute("data-field-def").forEach(function(element){calls.push(function(cb){var schemaId=element.getAttribute("data-field-def").split(".");if(2!==schemaId.length)return cb("Invalid data-field-def value : "+element.getAttribute("data-field-def")+", expected format is table.column");var tableDef=schema[schemaId[0]];if(!tableDef)return cb("Unknow table : "+schemaId[0].trim());if("grid"===schemaId[1])element.setAttribute("data-field","grid"),prepareGrid(element,schemaId[0],tableDef,cb);else{var colDef=null;if(tableDef.columns.some(function(c){if(c.name===schemaId[1].trim())return colDef=c,!0}),!colDef)return cb("Unknown column "+schemaId[1]+" in table "+schemaId[0]);element.hasAttribute("data-bind")||element.setAttribute("data-bind",colDef.name),element.setAttribute("data-field",colDef.type),colDef.size&&element.setAttribute("data-field-size",colDef.size),colDef.options&&Object.keys(colDef.options).forEach(function(k){element.setAttribute("data-field-"+k,colDef.options[k])}),prepareElement(element,schemaId[0],colDef,cb)}})}),series(calls,callback)}function extendsSchema(schemaBase,schemaExtends){Object.keys(schemaExtends).forEach(function(table){schemaBase[table]?schemaExtends[table].columns.forEach(function(col){schemaBase[table].columns.some(function(colBase){if(colBase.name===col.name)return Object.keys(col).forEach(function(k){colBase[k]=col[k]}),!0})||schemaBase[table].columns.push(col)}):schemaBase[table]=schemaExtends[table]})}function prepareElement(element,table,colDef,callback){if("selection"===colDef.type||"select"===colDef.type)if("SELECT"!==element.tagName&&0===element.getElementsByTagName("select").length){var select=document.createElement("SELECT"),emptyOption=document.createElement("OPTION");emptyOption.value="",emptyOption.innerHTML="&nbsp;",select.appendChild(emptyOption),element.appendChild(select),colDef.values&&Array.isArray(colDef.values)?(colDef.values.forEach(function(val){var option=document.createElement("OPTION");option.value=val,VeloxWebView.i18n?option.innerHTML=VeloxWebView.i18n.tr("fields.values."+table+"."+colDef.name+"."+val):option.innerHTML=val,select.appendChild(option)}),callback()):colDef.values&&"object"==typeof colDef.values?(Object.keys(colDef.values).forEach(function(val){var option=document.createElement("OPTION");option.value=val,option.innerHTML=colDef.values[val],select.appendChild(option)}),callback()):"2one"===colDef.values&&getPossibleValues(table,colDef,function(err,values){if(err)return callback(err);Object.keys(values).forEach(function(k){var option=document.createElement("OPTION");option.value=k,option.innerHTML=values[k],select.appendChild(option)}),callback()})}else callback();else callback()}function getPossibleValues(table,colDef,callback){if(!apiClient)return callback("You must give the VeloxServiceClient VeloxWebView.fieldsSchema.configure options to use the selection 2one fields");var otherTable=colDef.otherTable,valColumn=colDef.valFields;if(otherTable&&valColumn||schema[table].fk.some(function(fk){if(fk.thisColumn===colDef.name)return otherTable||(otherTable=fk.targetTable),valColumn||(valColumn=fk.targetColumn),!0}),!otherTable)return callback("Can't find target table for "+table+"."+colDef.name+" you should define a FK or give option otherTable in col def");if(!valColumn)return callback("Can't find target column value for "+table+"."+colDef.name+" you should define a FK or give option valField in col def");var orderBy=colDef.orderBy;if(!orderBy&&colDef.labelField){var orderFields=[];schema[otherTable].columns.forEach(function(c){-1!==colDef.labelField.indexOf(c.name)&&orderFields.push(c.name)}),orderFields.length>0&&(orderBy=orderFields.sort(function(f1,f2){return colDef.labelField.indexOf(f1)-colDef.labelField.indexOf(f2)}).join(","))}orderBy||(orderBy=schema[otherTable].pk.join(",")),apiClient.__velox_database[otherTable].search(colDef.search||{},orderBy,function(err,results){if(err)return callback(err);var values={};results.forEach(function(r){var label=colDef.labelField||valColumn;schema[otherTable].columns.forEach(function(c){label=label.replace(c.name,r[c.name])}),values[r[valColumn]]=label}.bind(this)),callback(null,values)}.bind(this))}function prepareGrid(element,tableName,tableDef,callback){var listTables=element.getElementsByTagName("TABLE"),table=null;if(0===listTables.length){table=document.createElement("TABLE");element.append(table)}else table=listTables[0];!table.getAttribute("recid")&&tableDef.pk&&1===tableDef.pk.length&&table.setAttribute("recid",tableDef.pk[0]);var listTH=Array.prototype.slice.call(table.getElementsByTagName("TH")),calls=[];if(0===listTH.length){listTH=[];var listThead=element.getElementsByTagName("THEAD"),thead=null;if(0===listThead.length){thead=document.createElement("THEAD");table.appendChild(thead)}else thead=listThead[0];var tr=document.createElement("TR");thead.appendChild(tr),tableDef.columns.forEach(function(colDef){0!==colDef.name.indexOf("velox_")&&calls.push(function(cb){var th=document.createElement("TH");tr.appendChild(th),th.setAttribute("data-field-name",colDef.name),prepareGridThInnerHTML(tableName,colDef,function(err,innerHTML){if(err)return cb(err);th.innerHTML=innerHTML,th.setAttribute("data-field-type",colDef.type),colDef.options&&Object.keys(colDef.options).forEach(function(k){th.setAttribute("data-field-"+k,colDef.options[k])}),cb()})}.bind(this))})}else listTH.forEach(function(th){var thName=th.getAttribute("data-field-name"),colDef=null;tableDef.columns.some(function(c){if(c.name===thName)return colDef=c,!0}),colDef&&calls.push(function(cb){if(th.getAttribute("data-field-type")||th.setAttribute("data-field-type",colDef.type),colDef.options&&Object.keys(colDef.options).forEach(function(k){th.getAttribute("data-field-"+k)||th.setAttribute("data-field-"+k,colDef.options[k])}),th.innerHTML){if(1===th.children.length&&"SCRIPT"===th.children[0].tagName){var label=document.createElement("LABEL");VeloxWebView.i18n?label.innerHTML=VeloxWebView.i18n.tr("fields."+tableName+"."+colDef.name):label.innerHTML=colDef.label||colDef.name,th.appendChild(label)}cb()}else prepareGridThInnerHTML(tableName,colDef,function(err,innerHTML){if(err)return cb(err);th.innerHTML=innerHTML,cb()}.bind(this))})});VeloxWebView._asyncSeries(calls,callback)}function prepareGridThInnerHTML(table,colDef,callback){var innerHTML="";if(innerHTML=VeloxWebView.i18n?VeloxWebView.i18n.tr("fields."+table+"."+colDef.name):colDef.label||colDef.name,"2one"===colDef.values)getPossibleValues(table,colDef,function(err,values){if(err)return callback(err);var script="<script>";script+="var values = "+JSON.stringify(values)+";",script+="return values[record['"+colDef.name+"']] || '';",callback(null,innerHTML=(script+="<\/script>")+innerHTML)});else if(Array.isArray(colDef.values)){script="<script>";VeloxWebView.i18n?script+='return VeloxWebView.i18n.tr("fields.values.'+table+"."+colDef.name+'."+record["'+colDef.name+'"]) ;':script+="return record['"+colDef.name+"'] ;",callback(null,innerHTML=(script+="<\/script>")+innerHTML)}else if("object"==typeof colDef.values){var script="<script>";script+="var values = "+JSON.stringify(colDef.values)+" ;",script+="return values[record['"+colDef.name+"']] ;",callback(null,innerHTML=(script+="<\/script>")+innerHTML)}else callback(null,innerHTML)}var extension={};extension.name="fieldsSchema";var schema,schemaExtend,apiClient;extension.mustRunBefore=["fields"],extension.init=function(cb){var view=this;getSchema(function(err,schema){if(err)return cb(err);schema?doInitView.bind(view)(cb):(view.elementsHavingAttribute("data-field-def").length>0&&console.error("You must set the schema with VeloxWebView.fieldsSchema.setSchema before instanciate your views"),cb())})},extension.extendsGlobal={},extension.extendsGlobal.fieldsSchema={},extension.extendsGlobal.fieldsSchema.getSchema=function(){return schema},extension.extendsGlobal.fieldsSchema.configure=function(options){if(!options.schema&&!options.apiClient)throw"you should provide either a schema or an apiClient option";if(apiClient=options.apiClient,schema=options.schema,schemaExtend=options.schemaExtend,schema&&options.schemaExtend&&extendsSchema(schema,options.schemaExtend),options.addLabelToFields){if(!VeloxWebView.i18n)throw"you should add the i18n extension to use the option addLabelToFields";VeloxWebView.fields.addDecorator(function(element,fieldType){if("grid"!==fieldType){var fieldDef=element.getAttribute("data-field-def");if(fieldDef&&!element.hasAttribute("data-field-nolabel")){var label=document.createElement("LABEL"),text=document.createTextNode(VeloxWebView.tr("fields."+fieldDef));if("boolean"===fieldType||"bool"===fieldType||"checkbox"===fieldType){var input=element.querySelector("input");element.removeChild(input),label.appendChild(input)}label.appendChild(text),element.insertBefore(label,element.children[0])}}})}};var series=function(calls,callback){if(0===calls.length)return callback();calls=calls.slice();var doOne=function(){calls.shift()(function(err){if(err)return callback(err);0===calls.length?callback():doOne()})};doOne()};return extension}),function(global,factory){if("object"==typeof exports&&"undefined"!=typeof module){var VeloxScriptLoader=require("velox-scriptloader");module.exports=factory(VeloxScriptLoader)}else"function"==typeof define&&define.amd?define(["VeloxScriptLoader"],factory):global.VeloxWebView.registerExtension(factory(global.veloxScriptLoader))}(this,function(VeloxScriptLoader){"use strict";function doInitView(){var view=this;i18next.on("languageChanged",function(){doTranslateView.bind(view)()}),doTranslateView.bind(view)()}function doTranslateView(){for(var elements=this.elementsHavingAttribute("data-i18n"),regexpAttr=/^\[(.*)](.*)$/,i=0;i<elements.length;i++){var match,str=elements[i].getAttribute("data-i18n");if(null!==(match=regexpAttr.exec(str))){var attr=match[1],code=match[2];elements[i].setAttribute(attr,translate(code))}else elements[i].innerHTML=translate(str)}}function configureI18Next(options,callback){if(options.i18next&&(i18next=options.i18next),i18next)initI18Next(options,callback);else{if(console.debug("No i18next object given, we will load from CDN/bower. If you don't want this, include i18next "+I18NEXT_VERSION+" in your import scripts or give i18next object to VeloxWebView.i18n.configure function"),!VeloxScriptLoader)return callback("To have automatic script loading, you need to import VeloxScriptLoader");VeloxScriptLoader.load(I18NEXT_LIB,function(err){if(err)return callback(err);i18next=window.i18next,initI18Next(options,callback)})}}function initI18Next(options,callback){var opts={fallbackLng:"en",backend:{loadPath:"locales/{{lng}}.json"}};Object.keys(options).forEach(function(k){opts[k]=options[k]}),window.i18nextXHRBackend&&i18next.use(window.i18nextXHRBackend),window.i18nextBrowserLanguageDetector&&i18next.use(window.i18nextBrowserLanguageDetector),i18next.init(opts,function(err){i18nextInitDone=!0,console.debug("i18next init done"),err&&console.warn("Some translation file are missing",err),initListeners.forEach(function(l){l()}),initListeners=[],callback()})}function ensureInit(callback){if(i18next)return callback();initListeners.push(callback)}function setLang(lang,callback){callback||(callback=function(){}),ensureInit(function(){i18next.changeLanguage(lang,callback)})}function getLang(){return i18next?i18next.language:navigator.language||navigator.userLanguage}function onLanguageChanged(listener){ensureInit(function(){i18next.on("languageChanged",listener)})}function translate(str,params){return i18next?i18next.t.apply(i18next,arguments):console.error("i18next is not yet initialized")}var I18NEXT_VERSION="8.4.3",I18NEXT_LIB=[{name:"i18next",type:"js",version:I18NEXT_VERSION,cdn:"https://unpkg.com/i18next@$VERSION/i18next.js",bowerPath:"i18next/i18next.min.js"},{name:"i18next-xhr-backend",type:"js",version:"1.4.2",cdn:"https://unpkg.com/i18next-xhr-backend@$VERSION/i18nextXHRBackend.js",bowerPath:"i18next-xhr-backend/i18nextXHRBackend.min.js"},{name:"i18next-browser-languagedetector",type:"js",version:"2.0.0",cdn:"https://unpkg.com/i18next-browser-languagedetector@$VERSION/i18nextBrowserLanguageDetector.js",bowerPath:"i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"}],i18next=window.i18next,i18nextInitDone=!1,initListeners=[],extension={};return extension.name="i18n",extension.init=function(cb){var view=this;i18nextInitDone?(doInitView.bind(view)(),cb()):(console.debug("i18next is not initialized, initialization with default parameters"),configureI18Next({},function(err){if(err)return cb(err);doInitView.bind(view)(),cb()}))},extension.extendsProto={},extension.extendsProto.tr=function(trKey,params){return translate.apply(this,arguments)},extension.extendsGlobal={},extension.extendsGlobal.i18n={},extension.extendsGlobal.i18n.configure=function(options,callback){return configureI18Next(options,callback)},extension.extendsGlobal.i18n.setLang=function(lang,callback){return setLang(lang,callback)},extension.extendsGlobal.i18n.getLang=function(){return getLang()},extension.extendsGlobal.i18n.onLanguageChanged=function(listener){onLanguageChanged(listener)},extension.extendsGlobal.i18n.tr=extension.extendsProto.tr,extension.extendsGlobal.tr=extension.extendsProto.tr,extension}),function(global,factory){if("object"==typeof exports&&"undefined"!=typeof module){var VeloxScriptLoader=require("velox-scriptloader"),VeloxWebView=require("velox-webview");module.exports=factory(VeloxScriptLoader,VeloxWebView)}else"function"==typeof define&&define.amd?define(["VeloxScriptLoader","VeloxWebView"],factory):global.VeloxWebView.registerExtension(factory(global.veloxScriptLoader,global.VeloxWebView))}(this,function(VeloxScriptLoader,VeloxWebView){"use strict";function toggleRemoveEls(){var elsRemove=this.elementsHavingAttribute("data-list-remove");if(this.listAutoActive){var viewDef=this.parentView.views[this.viewId];viewDef.instances.indexOf(this)===viewDef.instances.length-1?elsRemove.forEach(function(elRemove){elRemove.style.display="none"}):elsRemove.forEach(function(elRemove){elRemove.style.display=""})}else elsRemove.forEach(function(elRemove){elRemove.style.display="none"})}function doInitView(){if(this.on("load",function(){Object.keys(this.views).forEach(function(viewId){this.views[viewId].instances.forEach(function(v){v.listAutoActive=this.views[viewId].listAutoActive}.bind(this))}.bind(this))}.bind(this)),this.bindPath&&"]"===this.bindPath[this.bindPath.length-1]&&-1!==this.bindPath.lastIndexOf("[")){var viewDef=this.parentView.views[this.viewId];viewDef.el.hasAttribute("data-list-auto")&&(this.isListAuto=!0),this.once("load",function(){this.elementsHavingAttribute("data-bind").forEach(function(element){element.addEventListener("change",function(){this.listAutoActive&&viewDef.instances.indexOf(this)===viewDef.instances.length-1&&this.parentView.addViewInstance(this.viewId,function(){})}.bind(this))}.bind(this)),this.elementsHavingAttribute("data-list-remove").forEach(function(elRemove){elRemove.addEventListener("click",function(){if(this.listAutoActive){var listIndex=viewDef.instances.indexOf(this);this.parentView.removeViewInstance(this.viewId,listIndex)}}.bind(this))}.bind(this)),this.parentView.on("load",toggleRemoveEls.bind(this)),this.parentView.on("viewInstanceRemoved",toggleRemoveEls.bind(this)),this.parentView.on("viewInstanceAdded",toggleRemoveEls.bind(this))}.bind(this))}}var extension={};return extension.name="list",extension.mustRunAfter=["fields"],extension.init=function(cb){var view=this;doInitView.bind(view)(),cb()},extension.extendsGlobal={},extension.extendsProto={},extension.extendsProto.startListAuto=function(viewId,callback){this.setListAuto(viewId,!0,callback)},extension.extendsProto.stopListAuto=function(viewId,callback){this.setListAuto(viewId,!1,callback)},extension.extendsProto.setListAuto=function(active,callback){callback||(callback=function(){}),this.isListAuto&&(this.listAutoActive=active);var calls=[];Object.keys(this.views).forEach(function(viewId){calls.push(function(cb){var viewDef=this.views[viewId];viewDef.el.hasAttribute("data-list-auto")&&(viewDef.listAutoActive=active);var instancesCalls=[];this.views[viewId].instances.forEach(function(subView){instancesCalls.push(function(cbInstance){subView.setListAuto(active,cbInstance)})}),this._asyncSeries(instancesCalls,function(err){if(err)return cb(err);if(active)if(viewDef.el.hasAttribute("data-list-auto")){var mustAddLine=!1;if(0===this.views[viewId].instances.length)mustAddLine=!0;else{var lastObj=this.views[viewId].instances[this.views[viewId].instances.length-1].getBoundObject();lastObj&&"{}"!==JSON.stringify(lastObj)&&(mustAddLine=!0)}mustAddLine?this.addViewInstance(viewId,cb):cb()}else cb();else cb()}.bind(this))}.bind(this))}.bind(this)),this._asyncSeries(calls,function(err){if(err)return callback(err);toggleRemoveEls.bind(this)(),callback()}.bind(this))},extension.extendsObj={},extension.extendsObj._updateDataFromView=function(viewId,baseData,dataObject){var viewData=VeloxWebView.prototype._updateDataFromView.call(this,viewId,baseData,dataObject);this.views[viewId].listAutoActive&&Array.isArray(viewData)&&viewData.splice(viewData.length-1,1)},extension});