!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.VeloxWebView=factory()}(this,function(){"use strict";function uuidv4(){return uuidBase||(uuidBase=void 0!==window.crypto&&crypto.getRandomValues?([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(c){return(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)}):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0;return("x"==c?r:3&r|8).toString(16)})),uuidBase+"-"+uuidInc++}function EventEmiter(){this.listeners={}}function evalExpr(currentData,expr){if(currentData){var argNames=[],argValues=[];Object.keys(currentData).forEach(function(k){argNames.push(k),argValues.push(currentData[k])});for(var i=0;i<20;){i++;try{return new Function(argNames.join(","),"return "+expr).apply(null,argValues)}catch(e){if("ReferenceError"===e.name){var varName=e.message.split(" ")[0].replace(/'/g,"");argNames.push(varName),argValues.push(void 0);continue}return console.error("Error while evaluing expr "+expr,e),!1}}return console.error("More than 20 retry of "+expr+" there is something wrong in it !"),!1}return!1}function pathExtract(obj,path,getParent){if(!path)return obj;var pathArray=path;pathArray=Array.isArray(path)?path.slice():path.split("."),getParent&&pathArray.pop();for(var objectPath=[],dataObject=obj;pathArray.length>0;){var p=pathArray.shift().trim(),index=null;-1!=p.indexOf("[")&&(index=p.substring(p.indexOf("[")+1,p.indexOf("]")).trim(),p=p.substring(0,p.indexOf("[")).trim()),dataObject&&(p&&"$parent"===p?dataObject=objectPath.pop():p&&"$this"!==p&&(objectPath.push(dataObject),dataObject=dataObject[p]),dataObject&&null!==index&&(dataObject=dataObject[index]))}return dataObject}function convertRelativeToAbsolutePath(base,relative){var finalPath=[];return base.split("/").concat(relative.split("/")).forEach(function(p){".."===p?finalPath.pop():"."!==p&&finalPath.push(p)}),finalPath.join("/")}function pathSetValue(obj,path,value){var pathArray=path.slice();Array.isArray(path)||(pathArray=path.split("."));for(var dataObject=obj;pathArray.length>0;){var p=pathArray.shift().trim(),index=null;-1!==p.indexOf("[")&&(index=parseInt(p.substring(p.indexOf("[")+1,p.indexOf("]")).trim(),10),p=p.substring(0,p.indexOf("[")).trim()),dataObject&&(0===pathArray.length?null!==index?(p&&"this"!==p&&(dataObject[p]||(dataObject[p]=[]),dataObject=dataObject[p]),dataObject[index]=value):dataObject[p]=value:(p&&"this"!==p&&(dataObject[p]||(dataObject[p]=null!==index?[]:{}),dataObject=dataObject[p]),dataObject&&null!==index&&(dataObject[index]||(dataObject[index]={}),dataObject=dataObject[index])))}}function asyncSeries(calls,callback){if(0===calls.length)return callback();(0,calls[0])(function(err){if(err)return callback(err);calls.length>50&&calls.length%50==0?setImmediate(function(){asyncSeries(calls.slice(1),callback)}):asyncSeries(calls.slice(1),callback)})}function insertChild(parentElement,element,insertBefore,insertAfter){var nextElement=null,previousElement=null;if(insertBefore||insertAfter){var children=parentElement.children;if(insertBefore){var afterChain=insertBefore;for(afterChain=Array.isArray(afterChain)?afterChain.slice():[afterChain];null===nextElement&&afterChain.length>0;)for(var afterId=afterChain.shift(),i=0;i<children.length;i++)if(children[i].getAttribute("data-vieworder-id")===afterId){nextElement=children[i];break}}if(insertAfter)if("string"==typeof insertAfter||"string"==typeof insertAfter[0]){for(var beforeId=1===insertAfter.length?insertAfter[0]:insertAfter,i=children.length-1;i>=0;i--)if(children[i].getAttribute("data-vieworder-id")===beforeId){previousElement=children[i];break}}else{var beforeChain=insertAfter;for(beforeChain=Array.isArray(beforeChain)?beforeChain.slice():[beforeChain];null===previousElement&&beforeChain.length>0;)for(var beforeId=beforeChain.shift(),i=0;i<children.length;i++)if(children[i].getAttribute("data-vieworder-id")===beforeId){previousElement=children[i];break}}}nextElement?parentElement.insertBefore(element,nextElement):previousElement?parentElement.insertBefore(element,previousElement.nextSibling):parentElement.appendChild(element)}function VeloxWebView(directory,name,options){EventEmiter.call(this),directory&&"object"==typeof directory&&(options=directory,directory=null,name=null),this.uid=uuidv4(),this.options=options||{},this.directory=directory,this.name=name,this.views={},this.initDone=!1,this.bindObject=null,this.bindPath=null,this.innerViewIds=[],this.waitCount=0,Object.defineProperty(this,"EL",{get:function(){if(!this.ids)throw"Try to access element before initialization, consider to use ensureInit()";var els=this.elements,elFound=!1;return els||(els={},Object.keys(this.ids).forEach(function(id){if(this.container.id===this.ids[id])els[id]=this.container;else try{els[id]=this.container.querySelector("#"+this.ids[id])}catch(e){els[id]=null}if(els[id]){var view=this,elAddEventListener=els[id].addEventListener;els[id].addEventListener=function(event,listener){elAddEventListener.call(els[id],event,function(ev){ev.viewOfElement=view,listener.bind(els[id])(ev)})},els[id].on=els[id].addEventListener,elFound=!0}}.bind(this)),this.innerViewIds.forEach(function(innerViewId){els[innerViewId.id]=innerViewId}.bind(this))),elFound&&(this.elements=els),els}.bind(this)}),VeloxWebView.extensions.forEach(function(extension){extension.extendsObj&&Object.keys(extension.extendsObj).forEach(function(key){this[key]=extension.extendsObj[key].bind(this)}.bind(this))}.bind(this))}var HTMLELEMENT_PROTO_KEYS=Object.keys(Element.prototype).concat(Object.keys(HTMLElement.prototype)),loadedCss={},parsedHTMLCache={},uuidBase=null,uuidInc=0;return EventEmiter.prototype.on=function(type,listener){return this.listeners[type]||(this.listeners[type]=[]),this.listeners[type].push(listener),this},EventEmiter.prototype.off=function(type,listener){var listeners=this.listeners[type];if(!listeners)return this;for(var i=0;i<listeners.length;i++)if(listeners[i]===listener){listeners.splice(i,1);break}return this},EventEmiter.prototype.once=function(type,listener){var once,self=this;this.on(type,once=function(){self.off(type,once),listener.call(self,arguments)})},EventEmiter.prototype.emit=function(type,data,source){var listeners=this.listeners[type];if(listeners)for(var i=0;i<listeners.length;i++)(0,listeners[i])({type:type,data:data,source:source||this})},VeloxWebView.prototype=Object.create(EventEmiter.prototype),VeloxWebView.prototype.constructor=VeloxWebView,VeloxWebView.prototype.open=function(data,pCallback){if("function"==typeof data&&(pCallback=data,data=null),pCallback||(pCallback=function(err){if(err)throw console.error("Unexpected error",err),"Unexpected error "+err}),this.opening)return console.warn("You are opening the view "+this.directory+" / "+this.name+" while it is already opening."),this.once("openDone",function(){this.open(data,pCallback)}.bind(this));this.opening=!0;var callback=function(err){this.opening=!1,pCallback(err)}.bind(this);if(this.initDone){if(this.container&&document.documentElement.contains(this.container))return this.bindObject=data,this.render(callback);this.container=null,this.close()}return this.container=this.options.container,this.bindObject=data||this.options.bindObject,this.bindPath=this.options.bindPath,this.containerParent=this.options.containerParent,this.staticHTML=this.options.html,this.staticCSS=this.options.css,this.getHTML(function(html){this.ids={},this.parseHTML(html,function(err,parsed){if(err)throw err;var cssStatics=parsed.cssStatics,cssFiles=parsed.cssFiles,functionInView=parsed.functionInView;this._loadCSS(cssStatics,cssFiles,function(){var clonedBody=parsed.xmlDoc.body.cloneNode(!0);this.replaceIds(clonedBody),this.addToContainer(clonedBody,parsed),this.prepareSubView();var calls=[];VeloxWebView.extensions.forEach(function(extension){extension.init&&calls.push(function(cb){if(0===extension.init.length)try{extension.init.bind(this)(),cb()}catch(err){cb(err)}else extension.init.bind(this)(function(err){cb(err)}.bind(this))}.bind(this))}.bind(this)),asyncSeries(calls,function(err){if(err)return callback(err);functionInView&&functionInView(this),this.initAutoEmit(),this.initDone=!0,this.emit("initDone"),this.render(function(err){if(err)return callback(err);this.show(),this.mustHide&&(this.hide(),this.mustHide=!1),callback(),this.emit("openDone",{view:this})}.bind(this))}.bind(this))}.bind(this))}.bind(this))}.bind(this)),this},VeloxWebView.prototype.addToContainer=function(clonedBody,parsedHTML){if("string"==typeof this.container&&(this.containerId=this.container,this.container=document.getElementById(this.container)),this.container){if(this.container.style.display="none",this.options.containerIsInside&&this.container.id){this.container.setAttribute("data-original-id",this.container.id);var modifiedId=this.container.id+"_-_"+uuidv4();this.ids[this.container.id]=modifiedId,this.container.id=modifiedId}this.container.innerHTML=clonedBody.innerHTML}else{if(!this.containerParent)throw this.containerId+" is not found";if(1===parsedHTML.childrenCount)this.container=clonedBody.firstChild;else{var div=document.createElement("DIV");div.appendChild(clonedBody),this.container=div}this.containerId&&(this.container.id=this.containerId),"string"==typeof this.containerParent&&(this.containerParent=document.getElementById(this.containerParent)),this.container.style.display="none",insertChild(this.containerParent,this.container,this.options.insertBefore,this.options.insertAfter)}},VeloxWebView.prototype.replaceIds=function(bodyNode){for(var elWithId=bodyNode.querySelectorAll("[id]"),i=0;i<elWithId.length;i++){var el=elWithId[i],id=el.id,uuidEl=uuidv4();if("#"===id[0])id=id.substring(1),this.ids[id]=id,el.id=id;else{var modifiedId=id+"_-_"+uuidEl;this.ids[id]=modifiedId,el.id=modifiedId,el.setAttribute("data-original-id",id);for(var elTarget=bodyNode.querySelectorAll('[data-target="#'+id+'"]'),y=0;y<elTarget.length;y++)elTarget[y].setAttribute("data-target","#"+modifiedId);for(var elHref=bodyNode.querySelectorAll('[href="#'+id+'"]'),y=0;y<elHref.length;y++)elHref[y].setAttribute("href","#"+modifiedId);for(var elFor=bodyNode.querySelectorAll('[for="'+id+'"]'),y=0;y<elFor.length;y++)elFor[y].setAttribute("data-target",modifiedId)}}},VeloxWebView.prototype.replacePaths=function(bodyNode){for(var elImg=bodyNode.querySelectorAll("img"),i=0;i<elImg.length;i++){var el=elImg[i];el.setAttribute("src",this.directory+"/"+el.getAttribute("src"))}},VeloxWebView.prototype.hide=function(){this.container&&this.initDone?(this.container.style.display="none",this.emit("hidden")):this.mustHide=!0},VeloxWebView.prototype.show=function(){this.container&&(this.container.style.display="",this.emit("displayed",{view:this}))},VeloxWebView.prototype.elementsHavingAttribute=function(attributeName,withIgnore){var elements=Array.prototype.slice.apply(this.container.querySelectorAll("["+attributeName+"]"));if(this.container.hasAttribute(attributeName)&&elements.push(this.container),elements.length>0){var blockToIgnore=this.container.querySelectorAll("[data-dont-process]");blockToIgnore.length>0&&(elements=elements.filter(function(el){for(var toIgnore=!1,y=0;y<blockToIgnore.length;y++){var bl=blockToIgnore[y];if(bl===el||bl.contains(el)){toIgnore=!0;break}}return!toIgnore}))}return elements},VeloxWebView.prototype.close=function(){this.emit("close"),!this.options.container&&this.options.containerParent&&this.containerParent&&this.container?this.containerParent.removeChild(this.container):this.container&&(this.container.innerHTML=""),this.ids=null,this.views={},this.elements=null,this.initDone=!1,this.boundElements=null},VeloxWebView.prototype.getBoundObject=function(){return pathExtract(this.bindObject,this.bindPath)},VeloxWebView.prototype.pathExtract=function(obj,path,getParent){return pathExtract(obj,path,getParent)},VeloxWebView.prototype.getHTML=function(callback){if(this.staticHTML)callback(this.staticHTML);else{var htmlUrl=this.directory+"/"+this.name+".html";this.getXHR(htmlUrl,callback)}},VeloxWebView.prototype.getXHR=function(url,callback){var xhr=new XMLHttpRequest;xhr.open("GET",url),xhr.onload=function(){200===xhr.status?callback.bind(this)(xhr.responseText):callback.bind(this)("Request to "+url+" failed.  Returned status of "+xhr.status)}.bind(this),xhr.send()},VeloxWebView.prototype.parseHTML=function(htmlOfView,callback){var parsed=parsedHTMLCache[htmlOfView];if(parsed)return callback(null,parsed);var html=htmlOfView.replace(/data-original-id=['"]{1}[^'"]*['"]{1}/g,""),cssStatics=[];this.staticCSS&&cssStatics.push(this.staticCSS);var cssFiles=[],functionInView=null,calls=[],xmlDoc=(new DOMParser).parseFromString(html,"text/html");if(xmlDoc.head.children.length>0)for(var child=xmlDoc.head.children[0],scriptIndex=0;child&&("SCRIPT"===child.tagName||"STYLE"===child.tagName);){if("SCRIPT"===child.tagName)if(child.hasAttribute("data-file"))(function(child){var jsPath=child.getAttribute("data-file");calls.push(function(cb){var jsUrl=this.directory+"/"+jsPath;this.getXHR(jsUrl,function(contents){var scriptBody=contents;scriptBody+="//# sourceURL=/"+this.directory+"/"+jsPath,functionInView=new Function("view",scriptBody),scriptIndex++,cb()})}.bind(this))}).bind(this)(child);else{var scriptBody=child.innerHTML;scriptBody+="//# sourceURL=/"+this.directory+"/"+this.name+(scriptIndex>0?"_"+scriptIndex:"")+".js",functionInView=new Function("view",scriptBody),scriptIndex++}else"STYLE"===child.tagName&&(child.hasAttribute("data-file")?cssFiles.push(child.getAttribute("data-file")):cssStatics.push(child.innerHTML));child=child.nextElementSibling}this.replacePaths(xmlDoc.body),asyncSeries(calls,function(err){if(err)return callback(err);parsed={childrenCount:xmlDoc.body.children.length,xmlDoc:xmlDoc,cssStatics:cssStatics,cssFiles:cssFiles,functionInView:functionInView},parsedHTMLCache[htmlOfView]=parsed,callback(null,parsed)})},VeloxWebView.loadStaticCss=function(css){if(!loadedCss[css]){var head=document.getElementsByTagName("head")[0],s=document.createElement("style");s.setAttribute("type","text/css"),s.styleSheet?s.styleSheet.cssText=css:s.appendChild(document.createTextNode(css)),head.appendChild(s),loadedCss[css]=!0}},VeloxWebView.prototype.loadStaticCss=VeloxWebView.loadStaticCss,VeloxWebView.prototype._loadCSS=function(cssStrings,cssFiles,callback){var calls=[];cssStrings.forEach(function(cssContent){this.loadStaticCss(cssContent)}.bind(this)),cssFiles.forEach(function(cssFile){calls.push(function(cb){this.loadCSSFile(cssFile,cb)}.bind(this))}.bind(this)),asyncSeries(calls,callback)},VeloxWebView.prototype.loadCSSFile=function(file,callback){var cssUrl=convertRelativeToAbsolutePath(this.directory,file);if(loadedCss[cssUrl])callback();else{var xhr=new XMLHttpRequest;xhr.open("GET",cssUrl),xhr.onreadystatechange=function(){if(xhr.readyState===XMLHttpRequest.DONE)if(404!==xhr.status){var link=document.createElement("link");link.rel="stylesheet",link.type="text/css",link.href=cssUrl,link.addEventListener("load",function(){callback()},!1),document.getElementsByTagName("head")[0].appendChild(link)}else callback()}.bind(this),xhr.onabort=function(){callback()},xhr.onerror=function(){callback()},xhr.send(),loadedCss[cssUrl]=!0}},VeloxWebView.prototype.ensureInit=function(callback){this.initDone?callback():this.once("initDone",callback)},VeloxWebView.prototype._addSubView=function(el){if(!Object.keys(this.views).some(function(k){return this.views[k].el===el}.bind(this))){var viewId=el.getAttribute("data-view-id");viewId||((viewId=el.id)||(viewId="v_"+uuidv4()),el.setAttribute("data-view-id",viewId));for(var nextElementInParent=el.nextElementSibling,nextElementIds=[];nextElementInParent;)nextElementInParent.hasAttribute("data-vieworder-id")||nextElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),nextElementIds.push(nextElementInParent.getAttribute("data-vieworder-id")),nextElementInParent=nextElementInParent.nextElementSibling;for(var previousElementInParent=el.previousElementSibling,previousElementIds=[];previousElementInParent;)previousElementInParent.hasAttribute("data-vieworder-id")||previousElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),previousElementIds.push(previousElementInParent.getAttribute("data-vieworder-id")),previousElementInParent=previousElementInParent.previousElementSibling;if(!this.views[viewId]){var viewAttr=el.getAttribute("data-view"),bindAttr=el.getAttribute("data-bind"),showIfAttr=el.getAttribute("data-show-if"),hideIfAttr=el.getAttribute("data-hide-if"),dir=this.directory;if(viewAttr){var lastSlash=viewAttr.lastIndexOf("/"),file=viewAttr;-1!==lastSlash&&(dir=viewAttr.substring(0,lastSlash),file=viewAttr.substring(lastSlash+1)),this.views[viewId]={elParent:el.parentElement,el:el,isBefore:nextElementIds.length>0?nextElementIds:null,isAfter:previousElementIds.length>0?previousElementIds:null,bindPath:bindAttr,dir:dir,file:file,showIf:showIfAttr,hideIf:hideIfAttr,instances:[]}}else this.views[viewId]={elParent:el.parentElement,el:el,isBefore:nextElementIds.length>0?nextElementIds:null,isAfter:previousElementIds.length>0?previousElementIds:null,bindPath:bindAttr,dir:dir,html:el.outerHTML,showIf:showIfAttr,hideIf:hideIfAttr,instances:[]}}}},VeloxWebView.prototype.prepareSubView=function(){var i,el,elementsSubs=[],elementsShowIf=this.container.querySelectorAll("[data-show-if]");for(i=0;i<elementsShowIf.length;i++)elementsSubs.push(elementsShowIf[i]);var elementsHideIf=this.container.querySelectorAll("[data-hide-if]");for(i=0;i<elementsHideIf.length;i++)elementsSubs.push(elementsHideIf[i]);var elements=this.container.querySelectorAll("[data-bind]");for(i=0;i<elements.length;i++)(el=elements[i]).getAttribute("data-bind").replace(/\s/g,"").match(/\[\]$/)&&elementsSubs.push(el);var elementsView=this.container.querySelectorAll("[data-view]");for(i=0;i<elementsView.length;i++)elementsSubs.push(elementsView[i]);if(elementsSubs.length>0){var blockToIgnore=this.container.querySelectorAll("[data-dont-process]");blockToIgnore.length>0&&(elementsSubs=elementsSubs.filter(function(el){for(var toIgnore=!1,y=0;y<blockToIgnore.length;y++){var bl=blockToIgnore[y];if(bl===el||bl.contains(el)){toIgnore=!0;break}}return!toIgnore}))}for(elementsSubs.forEach(function(el){for(var nextElementInParent=el.nextElementSibling;nextElementInParent;)nextElementInParent.hasAttribute("data-vieworder-id")||nextElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),nextElementInParent=nextElementInParent.nextElementSibling;for(var previousElementInParent=el.previousElementSibling;previousElementInParent;)previousElementInParent.hasAttribute("data-vieworder-id")||previousElementInParent.setAttribute("data-vieworder-id","v_"+uuidv4()),previousElementInParent=previousElementInParent.previousElementSibling}),i=0;i<elementsSubs.length;i++){for(var parent=(el=elementsSubs[i]).parentElement,isAlreadyInSubView=!1;parent&&parent!==this.container;){if(-1!==elementsSubs.indexOf(parent)){isAlreadyInSubView=!0;break}parent=parent.parentElement}var elementsSubViews=Array.prototype.slice.apply(el.querySelectorAll("[data-original-id]"));el.hasAttribute("data-original-id")&&elementsSubViews.push(el),elementsSubViews.forEach(function(elInner,z){if((elInner=elementsSubViews[z]).id=elInner.getAttribute("data-original-id"),elInner.id){elInner.removeAttribute("data-original-id");var fakeEl={id:elInner.id,el:el,listeners:{},addEventListener:function(event,listener){this.listeners[event]||(this.listeners[event]=[]),this.listeners[event].push(listener)},isFake:!0};HTMLELEMENT_PROTO_KEYS.forEach(function(k){-1===Object.keys(fakeEl).indexOf(k)&&("function"==typeof elInner[k]?fakeEl[k]=function(){if(fakeEl.realEl)return fakeEl.realEl[k].apply(fakeEl.realEl,arguments)}:Object.defineProperty(fakeEl,k,{get:function(){return fakeEl.realEl?fakeEl.realEl[k]:null},set:function(value){fakeEl.realEl&&(fakeEl.realEl[k]=value)}}))}),this.innerViewIds.push(fakeEl)}}.bind(this)),isAlreadyInSubView||this._addSubView(el)}Object.keys(this.views).forEach(function(viewId){this.views[viewId].elParent.removeChild(this.views[viewId].el)}.bind(this))},VeloxWebView.prototype._transformData=function(callback){if(!this.options.transformData)return callback();if(1===this.options.transformData.length)try{var transformed=this.options.transformData(this.bindObject);if(!transformed)return callback("The transformData function should return the modified value");this.bindObject=transformed,callback()}catch(err){callback(err)}else 1===this.options.transformData.length?this.options.transformData(this.bindObject,function(err,transformed){return err?callback(err):transformed?(this.bindObject=transformed,void callback()):callback("The transformData function should give back the modified value on callback (err, modifiedValue)")}):callback("The transformData function should take argument (data) or (data, callback)")},VeloxWebView.prototype.getSubView=function(idSubView){if(!this.views[idSubView])throw"The subview "+idSubView+" does not exists in view "+this.name+", make sure you add an id attribute on the containing element";return this.views[idSubView].instances[0]},VeloxWebView.prototype.render=function(dataToRender,callbackParam){this.ensureInit(function(){if(this.elements=null,"function"==typeof dataToRender&&(callbackParam=dataToRender,dataToRender=void 0),void 0!==dataToRender&&(this.bindPath?pathSetValue(this.bindObject,this.bindPath,dataToRender):this.bindObject=dataToRender),callbackParam||(callbackParam=function(){}),this.rendering)return callbackParam();this.rendering=!0;var callback=function(err){if(this.rendering=!1,err)return callbackParam(err);callbackParam()}.bind(this);if(!this.boundElements){this.boundElements=[];var allElements=Array.prototype.slice.apply(this.container.getElementsByTagName("*"));allElements.push(this.container),allElements.forEach(function(el){var bindPath=el.getAttribute("data-bind"),bindEl={el:el},isContainerOfNestedView=!1;el===this.container&&(el.getAttribute("data-view")?isContainerOfNestedView=!0:el.children.length>0&&(isContainerOfNestedView=!0)),isContainerOfNestedView||!bindPath||bindPath.replace(/\s/g,"").match(/\[\]$/)||(bindEl.bindPath=bindPath);for(var attributes=el.attributes,boundAttributes={},hasBoundAttribute=!1,i=0;i<attributes.length;i++)-1!==attributes[i].value.indexOf("${")&&-1!==attributes[i].value.indexOf("}")&&(boundAttributes[attributes[i].name]=attributes[i].value,hasBoundAttribute=!0);hasBoundAttribute&&(bindEl.boundAttributes=boundAttributes);for(var textNodes=Array.prototype.slice.apply(el.childNodes).filter(function(n){return n.nodeType===Node.TEXT_NODE}),boundTextNodes={},hasBoundTextNodes=!1,i=0;i<textNodes.length;i++)-1!==textNodes[i].textContent.indexOf("${")&&-1!==textNodes[i].textContent.indexOf("}")&&(boundTextNodes[i]=textNodes[i].textContent,hasBoundTextNodes=!0);hasBoundTextNodes&&(bindEl.boundTextNodes=boundTextNodes),(bindEl.bindPath||bindEl.boundAttributes||bindEl.boundTextNodes)&&this.boundElements.push(bindEl)}.bind(this))}if(!this.bindObject)return callback();this._transformData(function(err){if(err)return callback(err);var baseData=this.bindObject;this.bindPath&&(baseData=pathExtract(this.bindObject,this.bindPath)),this.boundElements.forEach(function(boundEl){var el=boundEl.el,bindPath=boundEl.bindPath;if(bindPath){var fullBindPath=(this.bindPath||"$this")+"."+bindPath;el===this.container&&(fullBindPath=this.bindPath);var bindData=pathExtract(this.bindObject,fullBindPath);if(el.setValue)el.getValue()!=bindData&&el.setValue(bindData);else if("INPUT"===el.tagName||"TEXTAREA"===el.tagName||"SELECT"===el.tagName)if("INPUT"===el.tagName&&"checkbox"===el.type){var checked=!0===bindData||"true"===bindData||"TRUE"===bindData||1===bindData||"1"===bindData;el.checked!==checked&&(el.checked=checked)}else null!==bindData&&void 0!==bindData||(bindData=""),el.value!=bindData&&(el.value=bindData);else null!==bindData&&void 0!==bindData||(bindData=""),"string"==typeof bindData&&/[0-3]{1}[0-9]{3}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}T[0-2]{1}[0-9]{1}:[0-5]{1}[0-9]{1}:[0-5]{1}[0-9]{1}.[0-9]{3}Z/.test(bindData)&&(bindData=new Date(bindData)),/[0-3]{1}[0-9]{3}-[0-1]{1}[0-9]{1}-[0-3]{1}[0-9]{1}/.test(bindData)&&(bindData=new Date(bindData)),bindData instanceof Date&&(bindData=0===bindData.getHours()&&0===bindData.getMinutes()&&0===bindData.getSeconds()&&0===bindData.getMilliseconds()?bindData.toLocaleDateString?bindData.toLocaleDateString():bindData.toDateString():bindData.toLocaleDateString?bindData.toLocaleDateString()+" "+bindData.toLocaleTimeString():bindData.toDateString()+" "+bindData.toTimeString()),el.textContent!=bindData&&(el.textContent=bindData)}if(boundEl.boundAttributes&&Object.keys(boundEl.boundAttributes).forEach(function(name){for(var originalValue=boundEl.boundAttributes[name],value=originalValue;-1!==value.indexOf("${");){var indexStart=value.indexOf("${"),indexEnd=value.indexOf("}");if(indexEnd<indexStart){console.error("Wrong syntax in "+originalValue);break}var expr=value.substring(indexStart+2,indexEnd),exprValue=evalExpr(baseData,expr);value=value.substring(0,indexStart)+exprValue+value.substring(indexEnd+1)}0===name.indexOf("attr-")&&(name=name.substring(name.indexOf("-")+1)),boundEl.el.getAttribute(name)!=value&&boundEl.el.setAttribute(name,value)}.bind(this)),boundEl.boundTextNodes){var textNodes=Array.prototype.slice.apply(el.childNodes).filter(function(n){return n.nodeType===Node.TEXT_NODE});Object.keys(boundEl.boundTextNodes).forEach(function(index){for(var originalValue=boundEl.boundTextNodes[index],value=originalValue;-1!==value.indexOf("${");){var indexStart=value.indexOf("${"),indexEnd=value.indexOf("}");if(indexEnd<indexStart){console.error("Wrong syntax in "+originalValue);break}var expr=value.substring(indexStart+2,indexEnd),exprValue=evalExpr(baseData,expr);value=value.substring(0,indexStart)+exprValue+value.substring(indexEnd+1)}textNodes[index].textContent!=value&&(textNodes[index].textContent=value)}.bind(this))}var event=document.createEvent("CustomEvent");event.initCustomEvent("bound",!1,!0,{value:bindData,baseData:pathExtract(this.bindObject,this.bindPath),bindPath:bindPath,view:this,data:pathExtract(this.bindObject,(this.bindPath||"$this")+"."+bindPath,!0)}),Object.keys(event.detail).forEach(function(k){event[k]=event.detail[k]}),el.dispatchEvent(event)}.bind(this));var event=document.createEvent("CustomEvent");event.initCustomEvent("bound",!1,!0,{value:this.getBoundObject(),baseData:this.bindObject,bindPath:this.bindPath,view:this,data:pathExtract(this.bindObject,this.bindPath,!0)}),Object.keys(event.detail).forEach(function(k){event[k]=event.detail[k]}),this.container.dispatchEvent(event);var calls=[];Object.keys(this.views).forEach(function(viewId){calls.push(function(cb){var view=this.views[viewId],bindPath=view.bindPath||"",shouldDisplay=!0;if(view.showIf){var showIfData=evalExpr(baseData,view.showIf);(!showIfData||Array.isArray(showIfData)&&0===showIfData.length)&&(shouldDisplay=!1)}if(view.hideIf){var hideIfData=evalExpr(baseData,view.hideIf);shouldDisplay=!1,hideIfData?hideIfData&&Array.isArray(hideIfData)&&0===hideIfData.length&&(shouldDisplay=!0):shouldDisplay=!0}var bindData=pathExtract(this.bindObject,(this.bindPath||"$this")+"."+bindPath.replace(/\s/g,"").replace(/\[\]$/,""));bindPath.length>0&&"]"===bindPath[bindPath.length-1]&&!bindData&&(shouldDisplay=!1);shouldDisplay?this.renderOneView(viewId,bindData,cb):(view.instances.splice(0).forEach(function(instance){instance.container.parentElement.removeChild(instance.container)}.bind(this)),cb())}.bind(this))}.bind(this)),asyncSeries(calls,function(){this.emit("load"),this.emit("render"),callback()}.bind(this))}.bind(this))}.bind(this))},VeloxWebView.prototype.renderOneView=function(viewId,bindData,callback){var view=this.views[viewId];Array.isArray(bindData)||(bindData=[bindData]);var calls=[];bindData.forEach(function(d,y){calls.push(function(cb){view.instances[y]?(view.instances[y].bindPath&&"]"===view.instances[y].bindPath[view.instances[y].bindPath.length-1]&&(view.instances[y].bindPath=view.instances[y].bindPath.substring(0,view.instances[y].bindPath.lastIndexOf("[")+1)+y+"]"),view.instances[y].bindObject=this.bindObject,view.instances[y].render(cb)):this.addViewInstance(viewId,cb)}.bind(this))}.bind(this)),view.instances.splice(bindData.length).forEach(function(instance){instance.container.parentElement.removeChild(instance.container)}.bind(this)),asyncSeries(calls,function(){callback()}.bind(this))},VeloxWebView.prototype.removeViewInstance=function(viewId,index){this.views[viewId].instances.splice(index,1).forEach(function(instance){instance.container.parentElement.removeChild(instance.container)}.bind(this)),this.emit("viewInstanceRemoved",{viewId:viewId,index:index})},VeloxWebView.prototype.addViewInstance=function(viewId,callback){var view=this.views[viewId],bindPath=view.bindPath||"",isAfter=view.isAfter;if(view.instances.length>0){var lastInstanceContainer=view.instances[view.instances.length-1].container;lastInstanceContainer.hasAttribute("data-vieworder-id")||lastInstanceContainer.setAttribute("data-vieworder-id","v_"+uuidv4()),isAfter=[lastInstanceContainer.getAttribute("data-vieworder-id")]}var parentEl=view.elParent,container=null;view.file&&(container=view.el.cloneNode(),insertChild(view.elParent,container,view.isBefore,isAfter));var viewOptions={containerParent:parentEl,container:container,containerIsInside:!!view.file,insertBefore:view.isBefore,insertAfter:isAfter,html:view.html,css:view.html?"":void 0,bindObject:null,bindPath:(this.bindPath?this.bindPath+".":"")+bindPath.replace(/\s/g,"").replace(/\[\]$/,"["+view.instances.length+"]")},v=new VeloxWebView(view.dir,view.file,viewOptions);v.viewId=viewId,v.parentView=this,view.instances.push(v);var _emit=v.emit;v.emit=function(event,data){_emit.bind(v)(event,data),this.emit(event,data,v)}.bind(this),v.open(function(err){if(err)return callback(err);for(var parents=[],loopV=v;loopV.parentView;)parents.push(loopV.parentView),loopV=loopV.parentView;parents.forEach(function(parent){parent.innerViewIds.forEach(function(innerViewId){v.ids[innerViewId.id]&&v.EL[innerViewId.id]&&!v.EL[innerViewId.id].isFake&&(innerViewId.realEl=v.EL[innerViewId.id],Object.keys(innerViewId.listeners).forEach(function(event){innerViewId.listeners[event].forEach(function(l){v.EL[innerViewId.id].addEventListener(event,l)})}))})}.bind(this)),v.bindObject=this.bindObject,v.render(function(err){if(err)return callback(err);callback(),this.emit("viewInstanceAdded",{viewId:viewId,index:view.instances.length-1})}.bind(this))}.bind(this))},VeloxWebView.prototype.reload=function(callback){this.render(callback)},VeloxWebView.prototype.getData=function(){return this.updateData({})},VeloxWebView.prototype.updateData=function(dataToUpdate){var baseData=dataToUpdate;return void 0===dataToUpdate&&(baseData=pathExtract(this.bindObject,this.bindPath)),baseData||(baseData={}),this.boundElements.forEach(function(boundEl){if(boundEl.bindPath){var el=boundEl.el,bindPath=boundEl.bindPath,value=void 0;el.getValue?value=el.getValue():"INPUT"!==el.tagName&&"TEXTAREA"!==el.tagName&&"SELECT"!==el.tagName||(value="INPUT"===el.tagName&&"checkbox"===el.type?el.checked:el.value),void 0!==value&&pathSetValue(baseData,bindPath,value)}}.bind(this)),Object.keys(this.views).forEach(function(viewId){this._updateDataFromView(viewId,baseData,dataToUpdate)}.bind(this)),baseData},VeloxWebView.prototype._updateDataFromView=function(viewId,baseData,dataObject){var view=this.views[viewId],viewBindPath=view.bindPath;viewBindPath&&(viewBindPath=viewBindPath.replace(/\s/g,"").replace(/\[\]$/,""));var viewData=pathExtract(baseData,viewBindPath);return viewData||pathSetValue(baseData,viewBindPath,viewData=[]),view.instances.forEach(function(instance,i){"]"===instance.bindPath[instance.bindPath.length-1]&&(instance.bindPath=instance.bindPath.substring(0,instance.bindPath.lastIndexOf("[")+1)+i+"]",viewData[i]||(viewData[i]={})),instance.updateData(viewData[i])}.bind(this)),Array.isArray(viewData)&&viewData.length>0&&viewData.splice(view.instances.length),viewData},VeloxWebView.prototype.initAutoEmit=function(){for(var emitters=this.elementsHavingAttribute("data-emit"),i=0;i<emitters.length;i++)(function(i){var el=emitters[i],event=el.getAttribute("data-emit");event||(event="click"),el.addEventListener(event,function(){var id=el.getAttribute("data-original-id");this.emit(id,{data:this.getBoundObject(),currentData:this.getBoundObject(),parentData:pathExtract(this.bindObject,this.bindPath,!0),view:this})}.bind(this))}).bind(this)(i)},VeloxWebView.startWait=function(message){message||(message=this.options?this.options.defaultWaitMessage:null),this.waitCount||(this.showWaiterTimeout=setTimeout(function(){this._showWaiter(message)}.bind(this),this.options&&this.options.waiterDelay?this.options.waiterDelay:300)),this.waitCount||(this.waitCount=0),this.waitCount++},VeloxWebView.prototype.startWait=VeloxWebView.startWait.bind(VeloxWebView),VeloxWebView.endWait=function(){0===--this.waitCount&&(clearTimeout(this.showWaiterTimeout),this._hideWaiter())},VeloxWebView.prototype.endWait=VeloxWebView.endWait.bind(VeloxWebView),VeloxWebView.closeAllWaiters=function(){this.waitCount>0&&(this.waitCount=0,clearTimeout(this.showWaiterTimeout),this._hideWaiter())},VeloxWebView.prototype.closeAllWaiters=VeloxWebView.closeAllWaiters.bind(VeloxWebView),VeloxWebView.info=function(message,callback){window.alert(message),callback&&callback()},VeloxWebView.prototype.info=VeloxWebView.info.bind(VeloxWebView),VeloxWebView.error=VeloxWebView.info.bind(VeloxWebView),VeloxWebView.prototype.error=VeloxWebView.prototype.info,VeloxWebView.endWaitError=function(message,callback){this.endWait(),this.error(message,callback)},VeloxWebView.prototype.endWaitError=VeloxWebView.endWaitError.bind(VeloxWebView),VeloxWebView.longTask=function(doTask,message,callback){"function"==typeof message&&(callback=message,message=null),callback||(callback=function(){}),this.startWait(message),"function"==typeof doTask?doTask(function(error){if(error)return this.endWaitError(error),callback(error);this.endWait(),callback()}.bind(this)):doTask.constructor&&"Promise"===doTask.constructor.name&&doTask.then(function(){this.endWait(),callback()}.bind(this)).catch(function(error){this.endWaitError(error),callback(error)}.bind(this))},VeloxWebView.prototype.longTask=VeloxWebView.longTask.bind(VeloxWebView),VeloxWebView._showWaiter=function(message){this.loadStaticCss("@keyframes velox_spinner { to {transform: rotate(360deg);} }.velox_overlay {     position: fixed;     top: 0;     left: 0;     right: 0;     bottom: 0;     background-color: rgba(0, 0, 0, 0.61);     z-index: 1500;   }.velox_waitmsg {     color: white;     position: absolute;    top: calc(50% + 30px);    left: 0;    width: 100%;    text-align: center;  }.velox_spinner:before {     content: '';    box-sizing: border-box;    position: absolute;    top: 50%;    left: 50%;    width: 20px;    height: 20px;    margin-top: -10px;    margin-left: -10px;    border-radius: 50%;    border: 2px solid #ccc;    border-top-color: #333;    animation: velox_spinner .6s linear infinite;  }"),this.waiterDiv=document.createElement("div"),this.waiterDiv.className="velox_overlay";var spinnerDiv=document.createElement("div");if(spinnerDiv.className="velox_spinner",this.waiterDiv.appendChild(spinnerDiv),message){var msgDiv=document.createElement("div");msgDiv.className="velox_waitmsg",msgDiv.innerHTML=message,this.waiterDiv.appendChild(msgDiv)}document.body.appendChild(this.waiterDiv)},VeloxWebView.prototype._showWaiter=VeloxWebView._showWaiter.bind(VeloxWebView),VeloxWebView._hideWaiter=function(){this.waiterDiv&&(this.waiterDiv.parentElement&&this.waiterDiv.parentElement.removeChild(this.waiterDiv),this.waiterDiv=null)},VeloxWebView.prototype._hideWaiter=VeloxWebView._hideWaiter.bind(VeloxWebView),VeloxWebView.prototype._asyncSeries=asyncSeries,VeloxWebView._asyncSeries=asyncSeries,VeloxWebView.extensions=[],VeloxWebView.registerExtension=function(extension){VeloxWebView.extensions.push(extension),extension.extendsProto&&Object.keys(extension.extendsProto).forEach(function(key){VeloxWebView.prototype[key]=extension.extendsProto[key]}),extension.extendsGlobal&&Object.keys(extension.extendsGlobal).forEach(function(key){VeloxWebView[key]=extension.extendsGlobal[key]});var indexes={};VeloxWebView.extensions.forEach(function(ext,i){indexes[ext.name]=i}),VeloxWebView.extensions.forEach(function(ext){ext.mustRunBefore&&ext.mustRunBefore.forEach(function(other){VeloxWebView.extensions.forEach(function(extOther){extOther.name===other&&(extOther.mustRunAfter||(extOther.mustRunAfter=[]),extOther.mustRunAfter.push(ext.name))})})});for(var changed=!0,security=10;changed;)if(changed=!1,VeloxWebView.extensions.forEach(function(ext){ext.mustRunAfter&&ext.mustRunAfter.forEach(function(other){indexes[other]&&indexes[ext.name]<=indexes[other]&&(indexes[ext.name]=indexes[other]+1,changed=!0)})}),--security<=0){console.warn("There is a loop in extensions order before/after, the order is not guaranteed");break}VeloxWebView.extensions=VeloxWebView.extensions.sort(function(e1,e2){return indexes[e1.name]-indexes[e2.name]})},VeloxWebView}),function(global,undefined){"use strict";function clearImmediate(handle){delete tasksByHandle[handle]}function run(task){var callback=task.callback,args=task.args;switch(args.length){case 0:callback();break;case 1:callback(args[0]);break;case 2:callback(args[0],args[1]);break;case 3:callback(args[0],args[1],args[2]);break;default:callback.apply(undefined,args)}}function runIfPresent(handle){if(currentlyRunningATask)setTimeout(runIfPresent,0,handle);else{var task=tasksByHandle[handle];if(task){currentlyRunningATask=!0;try{run(task)}finally{clearImmediate(handle),currentlyRunningATask=!1}}}}if(!global.setImmediate){var registerImmediate,nextHandle=1,tasksByHandle={},currentlyRunningATask=!1,doc=global.document,attachTo=Object.getPrototypeOf&&Object.getPrototypeOf(global);attachTo=attachTo&&attachTo.setTimeout?attachTo:global,"[object process]"==={}.toString.call(global.process)?registerImmediate=function(handle){process.nextTick(function(){runIfPresent(handle)})}:function(){if(global.postMessage&&!global.importScripts){var postMessageIsAsynchronous=!0,oldOnMessage=global.onmessage;return global.onmessage=function(){postMessageIsAsynchronous=!1},global.postMessage("","*"),global.onmessage=oldOnMessage,postMessageIsAsynchronous}}()?function(){var messagePrefix="setImmediate$"+Math.random()+"$",onGlobalMessage=function(event){event.source===global&&"string"==typeof event.data&&0===event.data.indexOf(messagePrefix)&&runIfPresent(+event.data.slice(messagePrefix.length))};global.addEventListener?global.addEventListener("message",onGlobalMessage,!1):global.attachEvent("onmessage",onGlobalMessage),registerImmediate=function(handle){global.postMessage(messagePrefix+handle,"*")}}():global.MessageChannel?function(){var channel=new MessageChannel;channel.port1.onmessage=function(event){runIfPresent(event.data)},registerImmediate=function(handle){channel.port2.postMessage(handle)}}():doc&&"onreadystatechange"in doc.createElement("script")?function(){var html=doc.documentElement;registerImmediate=function(handle){var script=doc.createElement("script");script.onreadystatechange=function(){runIfPresent(handle),script.onreadystatechange=null,html.removeChild(script),script=null},html.appendChild(script)}}():registerImmediate=function(handle){setTimeout(runIfPresent,0,handle)},attachTo.setImmediate=function(callback){"function"!=typeof callback&&(callback=new Function(""+callback));for(var args=new Array(arguments.length-1),i=0;i<args.length;i++)args[i]=arguments[i+1];var task={callback:callback,args:args};return tasksByHandle[nextHandle]=task,registerImmediate(nextHandle),nextHandle++},attachTo.clearImmediate=clearImmediate}}("undefined"==typeof self?"undefined"==typeof global?this:global:self);